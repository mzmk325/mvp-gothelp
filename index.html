<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="color-scheme" content="light dark">
<meta name="theme-color" content="#FFFFFF">

<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>åƒä»€ä¹ˆ</title>
    <link rel="manifest" href="/manifest.webmanifest">
<script>if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js')}</script>
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: '#FF7A00',
              secondary: '#00B4D8',
              success: '#10B981',
              warning: '#EF4444',
              purple: '#8B5CF6',
              neutral: {
                100: '#F9FAFB',
                200: '#F3F4F6',
                300: '#E5E7EB',
                400: '#D1D5DB',
                500: '#9CA3AF',
                600: '#6B7280',
                700: '#4B5563',
                800: '#1F2937',
                900: '#111827'
              }
            },
            fontFamily: {
              'sf-pro': ['-apple-system','BlinkMacSystemFont','Segoe UI','Roboto','Helvetica Neue','Arial','sans-serif'],
            },
            borderRadius: { xl: '16px' },
            boxShadow: {
              light: '0 4px 12px rgba(0,0,0,0.05)',
              medium: '0 6px 16px rgba(0,0,0,0.08)'
            }
          }
        }
      }
    </script>
    <script>
      // è½»é‡é˜»æ­¢æ‰‹åŠ¿ç¼©æ”¾ï¼ˆæ³¨æ„ï¼šä¼šç¦ç”¨åŒæŒ‡ç¼©æ”¾ï¼‰
      document.addEventListener('gesturestart', e => e.preventDefault());
      let lastTouchEnd = 0;
      document.addEventListener('touchend', e => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) e.preventDefault();
        lastTouchEnd = now;
      }, false);
    </script>
    <style type="text/tailwindcss">   
      @layer utilities {
        /* iOS é˜²æ­¢è¾“å…¥æ¡†èšç„¦è§¦å‘ç¼©æ”¾ï¼šè¡¨å•åŸºçº¿ 16px */
@supports (-webkit-touch-callout: none) {
  input, select, textarea {
    font-size: 16px;
  }
}

/* è®©é¡µé¢æ›´â€œåŸç”Ÿâ€ï¼šé˜²æ­¢åŒå‡»æ”¾å¤§ã€ä¼˜åŒ–æ»šåŠ¨ */
html, body {
  -webkit-text-size-adjust: 100%;
  touch-action: manipulation;
  overscroll-behavior-y: none;
}
        .content-auto { content-visibility:auto; }
        .scrollbar-hide { -ms-overflow-style:none; scrollbar-width:none; }
        .scrollbar-hide::-webkit-scrollbar { display:none; }
        .transition-transform-shadow{ transition: transform .2s ease, box-shadow .2s ease; }
        .touch-target{ min-height:44px; min-width:44px; }
        .calendar-day{ aspect-ratio:1/1; }  
        /* â€”â€” iOS é¡¶éƒ¨å®‰å…¨åŒºï¼ˆé€‚é…çµåŠ¨å²›/åˆ˜æµ·ï¼‰â€”â€” */
.safe-top{
  /* è€ç‰ˆ iOS */
  padding-top: constant(safe-area-inset-top);
  /* æ–°ç‰ˆ iOS / iPhone 15 Pro Max ç­‰ */
  padding-top: env(safe-area-inset-top);
}
      }
      
    </style>
  </head>
  <body class="font-sf-pro bg-neutral-100 dark:bg-neutral-900 text-neutral-800 dark:text-neutral-100 transition-colors duration-300">
    <!-- é¡¶éƒ¨å¯¼èˆªï¼ˆé€šç”¨ï¼‰ -->
    <header class="safe-top sticky top-0 z-50 bg-white dark:bg-neutral-900 border-b border-neutral-200 dark:border-neutral-800">
      <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <h1 id="app-title" class="text-xl font-semibold">åƒä»€ä¹ˆ</h1>
        <div class="flex items-center space-x-4">
          <button id="theme-toggle" class="touch-target flex items-center justify-center rounded-full p-2 hover:bg-neutral-200 dark:hover:bg-neutral-800 transition-colors">
            <i class="fa-solid fa-moon dark:hidden text-neutral-700"></i>
            <i class="fa-solid fa-sun hidden dark:block text-neutral-300"></i>
          </button>
          <button class="touch-target flex items-center justify-center rounded-full p-2 hover:bg-neutral-200 dark:hover:bg-neutral-800 transition-colors">
            <i class="fa-solid fa-question-circle text-neutral-700 dark:text-neutral-300"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- ä¸»ä½“ï¼šä¸‰ä¸ªåˆ†åŒºï¼ˆä»Šå¤© / å†å² / æˆ‘çš„ï¼‰ -->
    <main class="container mx-auto px-4 py-6 pb-24">
      <!-- ä»Šå¤© -->
      <section id="page-today" class="block">
        <!-- ä»Šæ—¥æ ‡å‡†å¡ -->
        <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-6 border border-neutral-200 dark:border-neutral-700">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">ä»Šæ—¥æ ‡å‡†</h2>
            <span id="current-date" class="text-sm text-neutral-500 dark:text-neutral-400">â€”</span>
          </div>
          <div class="flex rounded-xl bg-neutral-100 dark:bg-neutral-700 p-1 mb-6">
            <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all" data-mode="high">å¢è‚Œ</button>
            <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-white dark:bg-neutral-600 shadow-sm transition-all" data-mode="normal">ç»´æŒ</button>
            <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all" data-mode="low">å‡è„‚</button>
          </div>
          <div class="grid grid-cols-3 gap-6 mb-6">
            <div class="text-center">
              <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-1">çƒ­é‡</div>
              <div class="flex items-center justify-center">
                <input id="goal-cal" class="w-16 text-center text-base font-medium bg-transparent border-b border-neutral-300 dark:border-neutral-600 focus:border-primary dark:focus:border-primary focus:outline-none" type="text" value="2000"/>
                <span class="text-xs text-neutral-500 dark:text-neutral-400 ml-1">kcal</span>
              </div>
            </div>
            <div class="text-center">
              <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-1">è›‹ç™½è´¨</div>
              <div class="flex items-center justify-center">
                <input id="goal-pro" class="w-16 text-center text-base font-medium bg-transparent border-b border-neutral-300 dark:border-neutral-600 focus:border-primary dark:focus:border-primary focus:outline-none" type="text" value="100"/>
                <span class="text-xs text-neutral-500 dark:text-neutral-400 ml-1">g</span>
              </div>
            </div>
            <div class="text-center">
              <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-1">è„‚è‚ª</div>
              <div class="flex items-center justify-center">
                <input id="goal-fat" class="w-16 text-center text-base font-medium bg-transparent border-b border-neutral-300 dark:border-neutral-600 focus:border-primary dark:focus:border-primary focus:outline-none" type="text" value="65"/>
                <span class="text-xs text-neutral-500 dark:text-neutral-400 ml-1">g</span>
              </div>
            </div>
          </div>
          <div class="flex justify-between items-center">
            <button id="reset-goal" class="text-xs text-primary hover:text-primary/80 transition-colors">é‡ç½®ç›®æ ‡</button>
            <div class="flex space-x-2">
              <div class="flex items-center space-x-1">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input id="night-snack" class="sr-only peer" type="checkbox" />
                  <div class="w-9 h-5 bg-neutral-200 dark:bg-neutral-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                </label>
                <span class="text-xs">å¤œå®µ</span>
              </div>
              <div class="flex items-center space-x-1">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input id="snack" class="sr-only peer" type="checkbox" />
                  <div class="w-9 h-5 bg-neutral-200 dark:bg-neutral-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
                </label>
                <span class="text-xs">åŠ é¤</span>
              </div>
            </div>
          </div>
        </section>

        <!-- é€‰æ‹©é¤æ¬¡ -->
        <section class="mb-6 overflow-x-auto scrollbar-hide">
          <div class="flex space-x-2 pb-2 min-w-max">
            <button id="breakfast-chip" class="px-5 py-2 rounded-xl text-sm font-medium bg-neutral-100 dark:bg-neutral-700 transition-transform-shadow touch-target">æ—©é¤</button>
<button id="lunch-chip"     class="px-5 py-2 rounded-xl text-sm font-medium bg-neutral-100 dark:bg-neutral-700 transition-transform-shadow touch-target">åˆé¤</button>
<button id="dinner-chip"    class="px-5 py-2 rounded-xl text-sm font-medium bg-primary text-white transition-transform-shadow touch-target">æ™šé¤</button>
            <button id="night-snack-chip" class="px-5 py-2 rounded-xl text-sm font-medium bg-neutral-100 dark:bg-neutral-700 transition-transform-shadow touch-target opacity-50 hidden">å¤œå®µ</button>
            <button id="snack-chip" class="px-5 py-2 rounded-xl text-sm font-medium bg-neutral-100 dark:bg-neutral-700 transition-transform-shadow touch-target opacity-50 hidden">åŠ é¤</button>
          </div>
        </section>

        <!-- è®°å½•æœ¬é¤ -->
        <section class="mb-8">
          <div class="flex flex-col items-center mb-6">
            <button id="camera-btn" class="w-24 h-24 rounded-full bg-primary flex items-center justify-center shadow-medium mb-4 transition-transform-shadow touch-target">
              <i class="fa-solid fa-camera text-white text-2xl"></i>
            </button>
            <input id="photo-input" type="file" accept="image/*" class="hidden" />
            <p class="text-xs text-neutral-500 dark:text-neutral-400 text-center max-w-xs">è¯·ä¿¯æ‹é£Ÿç‰©ï¼Œä»¥æå‡å‡†ç¡®åº¦</p>
          </div>
          <div class="mb-5">
            <textarea id="meal-text" class="w-full p-4 rounded-xl border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-800 min-h-[100px] resize-none focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary dark:focus:border-primary transition-all" placeholder="ç”¨æ–‡å­—è®°å½•"></textarea>
          </div>
          <button id="save-meal-btn" class="w-full py-3 bg-primary text-white rounded-xl font-medium shadow transition-transform-shadow touch-target">AIè¯†åˆ«æ–‡å­—</button>
        </section>

        <!-- ä»Šæ—¥ç»Ÿè®¡ -->
        
        <section class="mb-8 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-6 border border-neutral-200 dark:border-neutral-700">
          <h2 class="text-lg font-semibold mb-4">ä»Šæ—¥ç»Ÿè®¡</h2>
        
          <!-- çƒ­é‡ï¼ˆç¬¬1æ’ï¼‰ -->
          <div class="mb-6">
            <div class="flex justify-between text-sm mb-2">
              <span>çƒ­é‡æ‘„å…¥</span>
              <span id="calories-progress" class="font-medium">0 / 2000 kcal</span>
            </div>
            <div class="w-full h-2 bg-neutral-100 dark:bg-neutral-700 rounded-full overflow-hidden">
              <div id="calories-bar" class="h-full bg-primary rounded-full" style="width:0%"></div>
            </div>
          </div>
        
          <!-- è›‹ç™½è´¨ï¼ˆç¬¬2æ’ï¼‰ -->
          <div class="mb-5">
            <div class="flex justify-between text-sm mb-2">
              <span>è›‹ç™½è´¨</span>
              <span id="stat-protein" class="font-medium">0 g</span>
            </div>
            <div class="w-full h-2 bg-neutral-100 dark:bg-neutral-700 rounded-full overflow-hidden">
              <div id="protein-bar" class="h-full bg-primary rounded-full" style="width:0%"></div>
            </div>
            <div class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">
              ç›®æ ‡ <span id="goal-pro-label">100</span> g
            </div>
          </div>
        
          <!-- ç¢³æ°´ï¼ˆç¬¬3æ’ï¼‰ -->
          <div class="mb-5">
            <div class="flex justify-between text-sm mb-2">
              <span>ç¢³æ°´</span>
              <span id="stat-carbs" class="font-medium">0 g</span>
            </div>
            <div class="w-full h-2 bg-neutral-100 dark:bg-neutral-700 rounded-full overflow-hidden">
              <div id="carbs-bar" class="h-full bg-secondary rounded-full" style="width:0%"></div>
            </div>
            <div class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">
              ç›®æ ‡ <span id="goal-carbs-label">0</span> g
            </div>
          </div>
        
          <!-- è„‚è‚ªï¼ˆç¬¬4æ’ï¼‰ -->
          <div>
            <div class="flex justify-between text-sm mb-2">
              <span>è„‚è‚ª</span>
              <span id="stat-fat" class="font-medium">0 g</span>
            </div>
            <div class="w-full h-2 bg-neutral-100 dark:bg-neutral-700 rounded-full overflow-hidden">
              <div id="fat-bar" class="h-full bg-purple rounded-full" style="width:0%"></div>
            </div>
            <div class="text-xs text-neutral-500 dark:text-neutral-400 mt-1">
              ç›®æ ‡ <span id="goal-fat-label">65</span> g
            </div>
          </div>
        </section>

        <!-- ä»Šæ—¥å·²è®°å½•åˆ—è¡¨ -->
        <section>
          <h2 class="text-lg font-semibold mb-4 tracking-wide">ä»Šæ—¥å·²è®°å½•</h2>
          <div id="meals-list" class="space-y-3"></div>
          <div id="empty-state-today" class="hidden flex flex-col items-center justify-center py-12 text-center">
  <p class="text-neutral-500 dark:text-neutral-400">æ‹ç…§æˆ–æ–‡å­—è®°å½•å¼€å§‹</p>
</div>
          </div>
        </section>
      </section>

      <!-- å†å² -->
<section id="page-history" class="hidden">
  <!-- é¡¶éƒ¨ï¼šå‘¨æœŸ + è§†å›¾åˆ‡æ¢ -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <div class="flex justify-between items-center mb-5">
      <button id="prev-period" class="touch-target flex items-center justify-center rounded-full p-2 text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors">
        <i class="fa-solid fa-chevron-left text-sm"></i>
      </button>
      <h2 id="current-period" class="text-lg font-semibold">â€”</h2>
      <button id="next-period" class="touch-target flex items-center justify-center rounded-full p-2 text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors disabled:opacity-50 disabled:hover:bg-transparent">
        <i class="fa-solid fa-chevron-right text-sm"></i>
      </button>
    </div>

    <div class="flex rounded-xl bg-neutral-100 dark:bg-neutral-800 p-1">
      <button id="btn-week"  class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-white dark:bg-neutral-700 shadow-sm transition-all" data-view="week">å‘¨è§†å›¾</button>
      <button id="btn-month" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all" data-view="month">æœˆè§†å›¾</button>
    </div>
  </section>

  <!-- æ—¥å†ï¼ˆå‘¨/æœˆåº•éƒ¨ç”¨ JS å¡«å……ï¼‰ -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <div id="calendar-wrap"></div>
  </section>

  <!-- æŒ‡æ ‡åˆ‡æ¢ + å›¾è¡¨ -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <div class="flex rounded-xl bg-neutral-100 dark:bg-neutral-700 p-1 mb-6">
      <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium bg-white dark:bg-neutral-600 shadow-sm transition-all" data-metric="calories">çƒ­é‡</button>
      <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all" data-metric="protein">è›‹ç™½è´¨</button>
      <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all" data-metric="carbs">ç¢³æ°´</button>
      <button class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all" data-metric="fat">è„‚è‚ª</button>
    </div>
    <div id="metrics-chart" class="h-72"></div>
  </section>

  <!-- è®°å½•ç‡ + è¾¾æ ‡ç‡ï¼ˆæ¼”ç¤ºé™æ€ï¼‰ -->
  

  <!-- æŸå¤©è¯¦æƒ…ï¼ˆJS åŠ¨æ€æ¸²æŸ“ï¼‰ -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700" id="daily-details">
    <div class="mb-5">
      <h2 id="detail-date" class="text-lg font-semibold mb-1">â€”</h2>
      <p id="daily-target" class="text-sm text-neutral-500 dark:text-neutral-400">â€”</p>
    </div>
    <div id="daily-meals" class="space-y-4 mb-6"></div>
    <div id="daily-summary" class="pt-4 border-t border-neutral-200 dark:border-neutral-700 hidden"></div>
  </section>
</section>

      <!-- æˆ‘çš„ -->
      <section id="page-profile" class="hidden">
        <div class="space-y-6">
          <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-light p-6 border border-neutral-200 dark:border-neutral-700">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <div class="w-16 h-16 rounded-full bg-neutral-100 dark:bg-neutral-700 flex items-center justify-center text-neutral-400"><i class="fa-solid fa-user text-2xl"></i></div>
                <div>
                  <div class="text-xl font-semibold" id="profile-name">å¥åº·é¥®é£Ÿè€…</div>
                  <div class="text-neutral-500 dark:text-neutral-400 text-sm" id="profile-basic">ç”· 32å²</div>
                  <div class="text-neutral-500 dark:text-neutral-400 text-sm" id="profile-body">175cm / 70kg</div>
                </div>
              </div>
              <button id="profile-edit" class="px-4 py-2 rounded-xl border border-neutral-300 dark:border-neutral-600 text-sm">ç¼–è¾‘</button>
            </div>
          </section>
          <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-light p-6 border border-neutral-200 dark:border-neutral-700">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold">ä¼šå‘˜ä¸ä»˜è´¹çŠ¶æ€</h3>
              <button id="open-vip" class="px-4 py-2 bg-primary text-white rounded-xl text-sm">å»å¼€é€š</button>
            </div>
            <div class="text-neutral-700 dark:text-neutral-300 font-medium mb-1">è¯•ç”¨ä¸­</div>
            <div class="text-neutral-500 dark:text-neutral-400 text-sm">åˆ°æœŸæ—¥æœŸï¼š2023-12-31</div>
            <div class="mt-4 p-3 rounded-lg bg-neutral-50 dark:bg-neutral-700 text-sm text-neutral-600 dark:text-neutral-300"><i class="fa-solid fa-info-circle mr-2 text-primary"></i>é«˜çº§ä¼šå‘˜å¯äº«å—ä¸“ä¸šé¥®é£Ÿåˆ†æã€ä¸ªæ€§åŒ–æ¨èå’Œä¸“å±è¥å…»å¸ˆæŒ‡å¯¼ç­‰ç‰¹æƒ</div>
          </section>
          <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-light p-6 border border-neutral-200 dark:border-neutral-700">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold">è¥å…»ä¸ç›®æ ‡</h3>
              <button id="profile-goal-btn" class="px-4 py-2 rounded-xl border border-neutral-300 dark:border-neutral-600 text-sm">è¿›å…¥è®¾ç½®</button>
            </div>
            <div class="text-neutral-600 dark:text-neutral-300">
              ç›®æ ‡ï¼šçƒ­é‡ <span id="profile-goal-cal">2000</span>kcal ï½œ è›‹ç™½è´¨ <span id="profile-goal-pro">100</span>g ï½œ ç¢³æ°´ <span id="profile-goal-carbs">0</span>g ï½œ è„‚è‚ª <span id="profile-goal-fat">65</span>g
            </div>
          </section>
        </div>
        <div class="pt-8 pb-12 text-center text-xs text-neutral-400">
          Cc designed
        </div>
      </section>
<!-- è®¾ç½® Â· ä¸ªäººèµ„æ–™ï¼ˆäºŒçº§é¡µé¢ï¼‰ -->
<section id="page-settings-profile" class="hidden">
  <!-- é¡¶éƒ¨ï¼šè¿”å› + ä¿å­˜ -->
  <section class="mb-4 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-4 border border-neutral-200 dark:border-neutral-700 flex items-center justify-between">
    <button id="settings-back-profile" class="px-3 py-2 rounded-lg border border-neutral-300 dark:border-neutral-600 text-sm">è¿”å›</button>
    <div class="text-lg font-semibold">ä¸ªäººèµ„æ–™</div>
    <button id="settings-save-profile" class="px-4 py-2 bg-primary text-white rounded-xl text-sm">ä¿å­˜</button>
  </section>

  <!-- ä¸ªäººèµ„æ–™è¡¨å• -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <h3 class="text-lg font-semibold mb-3">ä¸ªäººèµ„æ–™</h3>
    <div class="grid grid-cols-2 gap-3 text-sm">
      <label class="flex flex-col gap-1"><span class="text-neutral-500">æ˜µç§°</span><input id="f-name" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">æ€§åˆ«ï¼ˆç”·/å¥³ï¼‰</span><input id="f-gender" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">å¹´é¾„</span><input id="f-age" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">èº«é«˜(cm)</span><input id="f-height" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
      <label class="flex flex-col gap-1"><span class="text-neutral-500">ä½“é‡(kg)</span><input id="f-weight" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
    </div>
  </section>
</section>

<!-- è®¾ç½® Â· è¥å…»ç›®æ ‡ï¼ˆäºŒçº§é¡µé¢ï¼‰ -->
<section id="page-settings-goals" class="hidden">
  <!-- é¡¶éƒ¨ï¼šè¿”å› + ä¿å­˜ -->
  <section class="mb-4 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-4 border border-neutral-200 dark:border-neutral-700 flex items-center justify-between">
    <button id="settings-back-goal" class="px-3 py-2 rounded-lg border border-neutral-300 dark:border-neutral-600 text-sm">è¿”å›</button>
    <div class="text-lg font-semibold">è¥å…»ç›®æ ‡é¢„è®¾</div>
    <button id="settings-save-goal" class="px-4 py-2 bg-primary text-white rounded-xl text-sm">ä¿å­˜</button>
  </section>

  <!-- ä¸‰å¥—è¥å…»ç›®æ ‡ -->
  <section class="mb-6 bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700">
    <h3 class="text-lg font-semibold mb-3">è¥å…»ç›®æ ‡é¢„è®¾</h3>
    <div class="space-y-4">
      <!-- å¢è‚Œ -->
      <div class="p-4 rounded-xl bg-neutral-50 dark:bg-neutral-700/50">
        <div class="font-medium mb-3">å¢è‚Œ</div>
        <div class="grid grid-cols-3 gap-3 text-sm">
          <label class="flex flex-col gap-1"><span>çƒ­é‡(kcal)</span><input id="g-high-cal" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
          <label class="flex flex-col gap-1"><span>è›‹ç™½(g)</span><input id="g-high-pro" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
          <label class="flex flex-col gap-1"><span>è„‚è‚ª(g)</span><input id="g-high-fat" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
        </div>
      </div>
      <!-- ç»´æŒ -->
      <div class="p-4 rounded-xl bg-neutral-50 dark:bg-neutral-700/50">
        <div class="font-medium mb-3">ç»´æŒ</div>
        <div class="grid grid-cols-3 gap-3 text-sm">
          <label class="flex flex-col gap-1"><span>çƒ­é‡(kcal)</span><input id="g-normal-cal" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
          <label class="flex flex-col gap-1"><span>è›‹ç™½(g)</span><input id="g-normal-pro" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
          <label class="flex flex-col gap-1"><span>è„‚è‚ª(g)</span><input id="g-normal-fat" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
        </div>
      </div>
      <!-- å‡è„‚ -->
      <div class="p-4 rounded-xl bg-neutral-50 dark:bg-neutral-700/50">
        <div class="font-medium mb-3">å‡è„‚</div>
        <div class="grid grid-cols-3 gap-3 text-sm">
          <label class="flex flex-col gap-1"><span>çƒ­é‡(kcal)</span><input id="g-low-cal" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
          <label class="flex flex-col gap-1"><span>è›‹ç™½(g)</span><input id="g-low-pro" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
          <label class="flex flex-col gap-1"><span>è„‚è‚ª(g)</span><input id="g-low-fat" type="number" class="p-2 rounded-lg border bg-white/80 dark:bg-neutral-700/60"></label>
        </div>
    </div>
    <p class="text-xs text-neutral-500 mt-3">æç¤ºï¼šç¢³æ°´ä¼šåœ¨é¦–é¡µæŒ‰ã€Œçƒ­é‡ - è›‹ç™½Ã—4 - è„‚è‚ªÃ—9ã€è‡ªåŠ¨æ¨ç®—ã€‚</p>
  </section>
</section>
    </main>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-neutral-800 border-t border-neutral-200 dark:border-neutral-700 z-40">
      <div class="grid grid-cols-3 h-16">
        <button id="tab-today" class="flex flex-col items-center justify-center text-primary"><i class="fa-solid fa-utensils mb-1"></i><span class="text-xs">ä»Šå¤©</span></button>
        <button id="tab-history" class="flex flex-col items-center justify-center text-neutral-500 dark:text-neutral-400"><i class="fa-solid fa-history mb-1"></i><span class="text-xs">å†å²</span></button>
        <button id="tab-profile" class="flex flex-col items-center justify-center text-neutral-500 dark:text-neutral-400"><i class="fa-solid fa-user mb-1"></i><span class="text-xs">æˆ‘çš„</span></button>
      </div>
    </nav>

    <!-- AI ç¡®è®¤å¼¹å±‚ -->
     <!-- å†å²é¤è¯¦æƒ…å¼¹å±‚ -->
<div id="hist-meal-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-end sm:items-center justify-center">
  <div class="bg-white dark:bg-neutral-800 w-full sm:w-[540px] rounded-t-2xl sm:rounded-2xl max-h-[85vh] overflow-y-auto">
    <div class="flex justify-between items-center p-5 border-b border-neutral-200 dark:border-neutral-700">
      <div class="text-lg font-semibold" id="hm-title">é¤æ¬¡è¯¦æƒ…</div>
      <button id="hm-close" class="p-2 text-neutral-500 dark:text-neutral-400"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="p-5">
      <div class="text-neutral-500 dark:text-neutral-400 mb-3" id="hm-date">â€”</div>

      <div id="hm-items" class="space-y-3">
        <!-- JS åŠ¨æ€æ¸²æŸ“æ¯ä¸ªé£Ÿç‰©é¡¹ä¸ºï¼šåç§° + å¯ç¼–è¾‘å® + kcal -->
      </div>

      <div class="mt-4 pt-4 border-t border-neutral-200 dark:border-neutral-700">
        <div class="flex justify-between font-semibold mb-1">
          <span>æœ¬é¤æ€»è®¡</span>
          <span id="hm-total-kcal">0kcal</span>
        </div>
        <div class="grid grid-cols-3 gap-2 text-sm text-neutral-500 dark:text-neutral-400">
          <div>è›‹ç™½è´¨ <span id="hm-total-pro">0</span>g</div>
          <div>ç¢³æ°´ <span id="hm-total-carb">0</span>g</div>
          <div>è„‚è‚ª <span id="hm-total-fat">0</span>g</div>
        </div>
      </div>

      <div class="mt-4">
        <label class="text-sm font-medium block mb-2">ä¿®æ­£è¯´æ˜</label>
        <textarea id="hm-note" class="w-full p-3 bg-neutral-100 dark:bg-neutral-700 rounded-xl text-sm resize-none" placeholder="å¦‚ï¼šå¤šåƒäº†ä¸€ä¸ªé¸¡è›‹"></textarea>
      </div>

      <div class="flex gap-3 mt-5">
        <button id="hm-delete" class="flex-1 py-3 rounded-xl border border-neutral-300 dark:border-neutral-600 text-sm">åˆ é™¤æœ¬é¤</button>
        <button id="hm-save"   class="flex-1 py-3 rounded-xl bg-primary text-white text-sm">åº”ç”¨ä¿®æ­£</button>
      </div>
    </div>
  </div>
</div>
    <div id="ai-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end">
      <div class="bg-white dark:bg-neutral-800 w-full rounded-t-2xl max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center p-6 border-b border-neutral-200 dark:border-neutral-700">
          <button id="cancel-ai" class="text-neutral-500 dark:text-neutral-400 touch-target">å–æ¶ˆ</button>
          <button id="confirm-ai" class="px-5 py-2 bg-primary text-white rounded-xl text-sm font-medium touch-target">ç¡®è®¤</button>
        </div>
        <div class="p-5 border-b border-neutral-200 dark:border-neutral-700">
          <div class="flex justify-center space-x-4 overflow-x-auto scrollbar-hide pb-3">
            <img id="ai-preview-img" class="w-48 h-48 rounded-xl object-cover hidden" alt="é¢„è§ˆ" />
          </div>
        </div>
        <div class="p-5 border-b border-neutral-200 dark:border-neutral-700">
          <h3 class="text-sm font-medium mb-4">AI è¯†åˆ«ç»“æœ</h3>
          <div id="ai-table" class="space-y-2 text-sm text-neutral-700 dark:text-neutral-300">
            <!-- åŠ¨æ€å¡«å…… -->
          </div>
          <div class="flex justify-between items-center mt-3">
            <div class="font-bold text-sm">åˆè®¡</div>
            <div id="ai-total" class="text-xl font-bold text-primary">0kcal</div>
          </div>
        </div>
        <div class="p-5">
          <div class="flex items-center space-x-3">
            <input id="ai-correction" class="flex-1 p-3 bg-neutral-100 dark:bg-neutral-700 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-primary/30" placeholder="ä¾‹å¦‚ï¼šæ²¡æœ‰è–¯æ¡ã€åªè¦æ±‰å ¡ã€å¤šä¸€ä»½ç±³é¥­" type="text"/>
            <button id="ai-send" class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white touch-target"><i class="fa-solid fa-paper-plane text-xs"></i></button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // è½»å­˜å‚¨åŠ©æ‰‹
      // === æ•°æ®æ¨¡å‹ ===
// MealItem: { name, grams, protein, carbs, fat, kcal }
// Meal: {
//   id, dateKey:'YYYY-MM-DD', time:number, mealType:'breakfast'|'lunch'|'dinner'|'snack'|'night',
//   source:'camera'|'text', text, items:MealItem[], totals:{kcal,protein,carbs,fat},
//   note:'', corrected:false, createdAt:number, updatedAt:number, backfill:boolean
// }
// User: { plan:'high'|'normal'|'low', goals:{cal,pro,fat,carb}, defaults:{...ä¸‰å¥—...}, isSubscribed:boolean, trialEnd:number }
// ======== é€šè¿‡Netlifyå‡½æ•°è°ƒç”¨é€šä¹‰åƒé—®API ========
// API Keyç°åœ¨é€šè¿‡ç¯å¢ƒå˜é‡å®‰å…¨å­˜å‚¨ï¼Œä¸å†æš´éœ²åœ¨å‰ç«¯ä»£ç ä¸­

const SYS_HINT = `ä½ æ˜¯ä¸€åè¥å…»åˆ†æåŠ©æ‰‹ã€‚

ä»»åŠ¡Aï¼šè¯†åˆ«å›¾ç‰‡æˆ–æ–‡å­—ä¸­çš„æ‰€æœ‰é£Ÿç‰©ï¼ˆå¯å¤šç§ï¼‰ï¼Œä¼°ç®—æ¯ç§è¥å…»ï¼ˆkcal/è›‹ç™½/è„‚è‚ª/ç¢³æ°´ï¼‰ã€‚è‹¥ä»½é‡ä¸ç¡®å®šåšå¸¸è¯†å‡è®¾å¹¶åœ¨notesè¯´æ˜ã€‚

ä»»åŠ¡Bï¼šä¿®æ­£æ—¶ï¼Œæ ¹æ®ç”¨æˆ·çš„ä¿®æ­£æŒ‡ä»¤å¯¹å½“å‰é£Ÿç‰©æ¸…å•è¿›è¡Œæ™ºèƒ½è°ƒæ•´ï¼š
- "æ²¡æœ‰XXX" æˆ– "åˆ é™¤XXX" â†’ ä»æ¸…å•ä¸­ç§»é™¤è¯¥é£Ÿç‰©
- "XXXæ”¹æˆYYY" â†’ æ›¿æ¢é£Ÿç‰©
- "å¤šä¸€ä»½XXX" æˆ– "å‡å°‘XXX" â†’ è°ƒæ•´ä»½é‡
- "åªæœ‰XXX" â†’ åªä¿ç•™æŒ‡å®šé£Ÿç‰©ï¼Œåˆ é™¤å…¶ä»–
- å…¶ä»–æŒ‡ä»¤æŒ‰ç…§å¸¸ç†ç†è§£æ‰§è¡Œ

è¯·ä»…è¿”å›ä¸¥æ ¼JSONï¼š
{
  "items": [ {"name":"...","protein":0,"fat":0,"carbs":0,"kcal":0} ],
  "notes": "å¯é€‰ä¿®æ­£è¯´æ˜"
}
è¦æ±‚ï¼šä¸­æ–‡èœåï¼›è›‹ç™½/è„‚è‚ª/ç¢³æ°´å¯ä¸€ä½å°æ•°ï¼›kcalä¸ºæ•´æ•°ã€‚`;

function calcTotals(items){
  const t = items.reduce((a,i)=>{
    const p=+i.protein||0, c=+i.carbs||0, f=+i.fat||0;
    const k = Number.isFinite(+i.kcal) ? Math.max(0, Math.round(+i.kcal)) : Math.round(p*4+c*4+f*9);
    a.kcal+=k; a.protein+=p; a.carbs+=c; a.fat+=f; return a;
  }, {kcal:0,protein:0,carbs:0,fat:0});
  t.protein=+t.protein.toFixed(1); t.carbs=+t.carbs.toFixed(1); t.fat=+t.fat.toFixed(1);
  return t;
}
// === ç”Ÿæˆä¿å­˜ç”¨çš„ç®€è¿°æ–‡æ¡ˆï¼šå¦‚ "ç‰›è‚‰é¢ x 1ã€é¦™è•‰ x 1" ===
function formatMealText(items){
  if (!Array.isArray(items) || items.length === 0) return '';
  // å…ˆæŠŠåŒåé£Ÿç‰©åˆå¹¶ç»Ÿè®¡æ•°é‡ï¼ˆç›®å‰é»˜è®¤æ¯é¡¹ 1 ä»½ï¼‰
  const map = new Map();
  for (const it of items) {
    const name = String(it?.name || 'é£Ÿç‰©').trim();
    if (!name) continue;
    map.set(name, (map.get(name) || 0) + 1);
  }
  return Array.from(map.entries()).map(([name, cnt]) => `${name} x ${cnt}`).join('ã€');
}

async function callAI({ text=null, image=null, mode='auto', prevJSON=null }){
  console.log('è°ƒç”¨é€šä¹‰åƒé—®API...', { text: text?.substring(0, 100), hasImage: !!image, mode });
  
  // è°ƒç”¨Netlifyå‡½æ•°
  const response = await fetch('/.netlify/functions/call-ai', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      text,
      image,
      mode,
      prevJSON
    })
  });

  console.log('Netlifyå‡½æ•°å“åº”çŠ¶æ€:', response.status);

  if (!response.ok) {
    const errorText = await response.text();
    console.error('Netlifyå‡½æ•°é”™è¯¯:', errorText);
    throw new Error(`APIè°ƒç”¨å¤±è´¥ (${response.status}): ${errorText}`);
  }

  const result = await response.json();
  console.log('Netlifyå‡½æ•°è¿”å›æ•°æ®:', result);

  if (result.error) {
    throw new Error(`APIè¿”å›é”™è¯¯: ${result.error}`);
  }

  return result;
}
const dateKeyOf = (ts)=> {
  const d = new Date(ts); const two=n=>n<10?'0'+n:''+n;
  return `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`;
};
const uid = ()=> 'm_' + Math.random().toString(36).slice(2,9) + Date.now();
let editingOldMealKey = null;   // è‹¥ä¸ä¸º nullï¼Œåˆ™ç¡®è®¤æ—¶è¦†ç›–è¿™æ¡æ—§é¤
let tempAiItemsForEdit = null;  // æš‚å­˜ AI è¿”å›çš„æ¡ç›®ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰

      // â€”â€” ç›¸æœº/å›¾ç‰‡é€‰æ‹©éœ€è¦ç”¨åˆ°çš„å˜é‡ â€”â€” 
      
let selectedImageData = null;  // ç”¨æ¥ä¿å­˜é€‰åˆ°çš„å›¾ç‰‡ï¼ˆBase64ï¼‰
const aiModal = document.getElementById('ai-modal');
// â€”â€” æ¸…ç†ä¸€æ¬¡ä¼šè¯ï¼ˆç”¨äºå…³é—­å¼¹å±‚å’Œæ¯æ¬¡æ–°å¼€è¯†åˆ«å‰ï¼‰ â€”â€”
function resetAiSession(){
  window.__aiSession = null;
  // æ¸…ç©ºè¡¨æ ¼ä¸åˆè®¡
  const table = document.getElementById('ai-table');
  if (table) table.innerHTML = '';
  const total = document.getElementById('ai-total');
  if (total) total.textContent = '0kcal';
  // æ¸…ç©ºä¿®æ­£è¾“å…¥
  const corr = document.getElementById('ai-correction');
  if (corr) corr.value = '';
  // æ¸…æ‰é¢„è§ˆå›¾
  const preview = document.getElementById('ai-preview-img');
  if (preview){
    preview.src = '';
    preview.classList.add('hidden');
  }
  // æ¸…æ‰ä¸Šä¸€å¼ å›¾ç‰‡çš„ base64
  selectedImageData = null;
}
// å…³é—­ AI å¼¹å±‚ï¼šç‚¹"å–æ¶ˆ"/ç‚¹è’™å±‚/æŒ‰ ESC éƒ½èƒ½å…³
function closeAiModal(){ 
  aiModal.classList.add('hidden'); 
  resetAiSession(); 
  // æ¸…ç†ç¼–è¾‘çŠ¶æ€
  window.currentEditableItems = null;
}
document.getElementById('cancel-ai').onclick = closeAiModal;
aiModal.addEventListener('click', (e) => { if (e.target === aiModal) closeAiModal(); });
window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAiModal(); });
const photoInput = document.getElementById('photo-input');
// å›¾ç‰‡å‹ç¼©å‡½æ•°
function compressImage(file, maxSizeMB = 2) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = () => {
      // è®¡ç®—å‹ç¼©å°ºå¯¸
      let { width, height } = img;
      const maxDimension = 1024; // æœ€å¤§è¾¹é•¿
      
      if (width > height && width > maxDimension) {
        height = (height * maxDimension) / width;
        width = maxDimension;
      } else if (height > maxDimension) {
        width = (width * maxDimension) / height;
        height = maxDimension;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // ç»˜åˆ¶å‹ç¼©åçš„å›¾ç‰‡
      ctx.drawImage(img, 0, 0, width, height);
      
      // è·å–å‹ç¼©åçš„base64ï¼Œè´¨é‡ä»0.8å¼€å§‹é€’å‡
      let quality = 0.8;
      let compressedData;
      
      do {
        compressedData = canvas.toDataURL('image/jpeg', quality);
        quality -= 0.1;
      } while (compressedData.length > maxSizeMB * 1024 * 1024 * 1.37 && quality > 0.1); // base64æ¯”åŸæ–‡ä»¶å¤§çº¦37%
      
      resolve(compressedData);
    };
    
    const reader = new FileReader();
    reader.onload = (e) => {
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// ç›‘å¬å›¾ç‰‡é€‰æ‹©ï¼šåªèµ°"å›¾ç‰‡é€šè·¯"ï¼Œå¹¶æ¸…ç©ºæ–‡å­—é¿å…æ··å…¥
photoInput.addEventListener('change', async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;

  try {
    // å‹ç¼©å›¾ç‰‡
    selectedImageData = await compressImage(file);
    console.log('åŸå§‹æ–‡ä»¶å¤§å°:', (file.size / 1024 / 1024).toFixed(2), 'MB');
    console.log('å‹ç¼©åå¤§å°:', (selectedImageData.length / 1024 / 1024 * 0.75).toFixed(2), 'MB');

    const corr = document.getElementById('ai-correction');
    if (corr) corr.value = '';

    // å…³é”®ï¼šæ¸…ç©ºæ–‡å­—ï¼Œç¡®ä¿ä¸æŠŠä¸Šä¸€æ¬¡æˆ–å½“å‰æ–‡å­—å¤¹å¸¦åˆ°å›¾ç‰‡è¯†åˆ«
    const mealInput = document.getElementById('meal-text');
    if (mealInput) mealInput.value = '';

    const previewEl = document.getElementById('ai-preview-img');
    if (previewEl) {
      previewEl.src = selectedImageData;
      previewEl.classList.remove('hidden');
    }

    aiModal.classList.remove('hidden');
    runAOnce(); // ä»…å›¾ç‰‡ +ï¼ˆå¯é€‰ï¼‰ä¿®æ­£
  } catch (error) {
    console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:', error);
    alert('å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
});
      const store = {
        get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def }catch{ return def } },
        set(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
      }
      function ymdKey(d=new Date()){
  const two = n => n<10?'0'+n:''+n;
  return `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`;
}

// â€”â€” ä¸‰å¥—é¢„è®¾ + å½“å‰æ¨¡å¼ â€”â€”
// ç»“æ„ï¼šgoalPresets = { high:{cal,pro,fat}, normal:{...}, low:{...} }
function getGoalPresets(){
  const saved = store.get('goalPresets', null);
  if (saved) return saved;
  const def = {
    high:   { cal:2500, pro:120, fat:80 },
    normal: { cal:2000, pro:100, fat:65 },
    low:    { cal:1500, pro: 80, fat:50 },
  };
  store.set('goalPresets', def);
  return def;
}
function setGoalPresets(p){ store.set('goalPresets', p); }

// å½“å‰æ¨¡å¼ï¼šhigh/normal/lowï¼ˆé»˜è®¤ normalï¼‰
function getCurrentMode(){ return store.get('currentMode', 'normal'); }
function setCurrentMode(m){ store.set('currentMode', m); }

// ä¸ªäººèµ„æ–™ï¼šä¿ç•™ä½ åŸæœ‰ç»“æ„
function getProfile(){
  return store.get('profile', { name:'å¥åº·é¥®é£Ÿè€…', gender:'ç”·', age:32, height:175, weight:70 });
}
function setProfile(p){ store.set('profile', p); }

// é¦–é¡µï¼šæŒ‰â€œå½“å‰æ¨¡å¼â€æŠŠé¢„è®¾çŒå…¥ä»Šå¤©ï¼ˆå¯æ‰‹åŠ¨æ”¹ï¼‰
function loadGoalsForToday(){
  const today = ymdKey();
  const todayGoals = store.get('todayGoals', null);
  const presets = getGoalPresets();
  const mode = getCurrentMode();
  const base = presets[mode] || presets.normal;

  const g = (todayGoals && todayGoals.date===today)
    ? todayGoals
    : { date:today, ...base };

  document.getElementById('goal-cal').value = g.cal;
  document.getElementById('goal-pro').value = g.pro;
  document.getElementById('goal-fat').value = g.fat;
  store.set('todayGoals', g);
  syncGoalLabels();
}

// æ‰‹åŠ¨æ”¹äº†é¦–é¡µæ•°å­—æ—¶ï¼Œä¿å­˜â€œä»Šå¤©è¦†ç›–â€
function saveTodayOverride(){
  const g = {
    date: ymdKey(),
    cal: +document.getElementById('goal-cal').value || 2000,
    pro: +document.getElementById('goal-pro').value || 100,
    fat: +document.getElementById('goal-fat').value || 65,
  };
  store.set('todayGoals', g);
}



     // ä¸»é¢˜æ¨¡å¼ï¼šauto | light | dark
// - autoï¼šæŒ‰æ—¶é—´åˆ‡ï¼ˆ19:00â€“06:00 = darkï¼‰
// - light/darkï¼šæ‰‹åŠ¨å›ºå®š
function applyThemeByMode(mode) {
  if(mode === 'auto') {
    const h = new Date().getHours();
    const shouldDark = (h >= 19 || h < 6);
    document.documentElement.classList.toggle('dark', shouldDark);
    localStorage.setItem('theme', shouldDark ? 'dark' : 'light'); // ä¿å­˜å½“å‰æ¨¡å¼
  } else {
    document.documentElement.classList.toggle('dark', mode === 'dark');
    localStorage.setItem('theme', mode);
  }

  // ğŸ‘‰ æ–°å¢ï¼šæ›´æ–° meta theme-color
  const metaColor = document.querySelector('meta[name="theme-color"]');
  if (metaColor) {
    const isDark = document.documentElement.classList.contains('dark');
    metaColor.setAttribute('content', isDark ? '#111827' : '#FFFFFF');
  }
}

// ç»‘å®šæŒ‰é’®ï¼šç‚¹å‡» = åœ¨ light/dark ä¹‹é—´åˆ‡æ¢å¹¶è¿›å…¥æ‰‹åŠ¨æ¨¡å¼ï¼›é•¿æŒ‰ 1.5s æ¢å¤ auto
const themeToggle = document.getElementById('theme-toggle');
let pressTimer = null;
themeToggle.addEventListener('mousedown', ()=>{ pressTimer = setTimeout(()=> setThemeMode('auto'), 1500); });
themeToggle.addEventListener('mouseup', ()=> clearTimeout(pressTimer));
themeToggle.addEventListener('mouseleave', ()=> clearTimeout(pressTimer));
themeToggle.addEventListener('click', () => {
  // å¦‚æœå½“å‰åœ¨ autoï¼Œåˆ™ä»¥å½“å‰å®é™… class ä¸ºåŸºå‡†åˆ‡åˆ°å¦ä¸€ç§ï¼Œå¹¶è¿›å…¥æ‰‹åŠ¨
  const curMode = getThemeMode();
  const isDark = document.documentElement.classList.contains('dark');
  const nextMode = (curMode==='auto' ? (isDark?'light':'dark') : (localStorage.getItem('theme')==='dark' ? 'light':'dark'));
  setThemeMode(nextMode);
  const st = window.__chartState || {};
initChart(st.metric || 'calories', historyView, periodStart, selectedDate); // åˆ·æ–°å›¾è¡¨é…è‰²
});

// å¯åŠ¨æ—¶åº”ç”¨
applyThemeByMode(getThemeMode());
// è‹¥åœ¨ auto æ¨¡å¼ä¸‹ï¼Œæ¯å°æ—¶æ ¡æ­£ä¸€æ¬¡
if(getThemeMode()==='auto'){
  setInterval(()=> applyThemeByMode('auto'), 60*60*1000);
}

      // é¡¶éƒ¨æ ‡é¢˜ä¸åˆ†åŒºåˆ‡æ¢
      const appTitle = document.getElementById('app-title');
      const pages = {
  today:    document.getElementById('page-today'),
  history:  document.getElementById('page-history'),
  profile:  document.getElementById('page-profile'),
  settingsProfile: document.getElementById('page-settings-profile'),
  settingsGoals:   document.getElementById('page-settings-goals'),
};
      function switchTab(tab){
        Object.values(pages).forEach(el => el.classList.add('hidden'));
        pages[tab].classList.remove('hidden');

        if (tab==='today')  appTitle.textContent = 'åƒä»€ä¹ˆ';
if (tab==='history'){ appTitle.textContent = 'å†å²è®°å½•'; initHistory(); }
if (tab==='profile') appTitle.textContent = 'æˆ‘çš„';
if (tab==='settingsProfile') appTitle.textContent = 'ä¸ªäººèµ„æ–™';
if (tab==='settingsGoals')   appTitle.textContent = 'è¥å…»ç›®æ ‡é¢„è®¾';

        // åº•éƒ¨é«˜äº®ï¼ˆä»…ä¸‰å¤§é¡µå‚ä¸é«˜äº®ï¼‰
        document.querySelectorAll('nav button').forEach(b=>b.classList.remove('text-primary'));
        if (['today','history','profile'].includes(tab)) {
          document.getElementById('tab-'+tab).classList.add('text-primary');
        }
      }
     // â€”â€” è®¾ç½®é¡µï¼šåŠ è½½/ä¿å­˜ï¼ˆæ‹†æˆä¸¤å¥—ï¼‰ â€”â€”

// ä¸ªäººèµ„æ–™ï¼šæŠŠæœ¬åœ°æ•°æ® â†’ è¡¨å•
function loadProfileForm(){
  const p = getProfile();
  document.getElementById('f-name').value   = p.name || '';
  document.getElementById('f-gender').value = p.gender || '';
  document.getElementById('f-age').value    = p.age || '';
  document.getElementById('f-height').value = p.height || '';
  document.getElementById('f-weight').value = p.weight || '';
}

// ä¸ªäººèµ„æ–™ï¼šä¿å­˜è¡¨å• â†’ æœ¬åœ° & åˆ·æ–°â€œæˆ‘çš„â€å’Œé¦–é¡µ
function saveProfileForm(){
  const p = {
    name:   (document.getElementById('f-name').value || '').trim() || 'å¥åº·é¥®é£Ÿè€…',
    gender: (document.getElementById('f-gender').value || '').trim() || 'ç”·',
    age:    +document.getElementById('f-age').value || 32,
    height: +document.getElementById('f-height').value || 175,
    weight: +document.getElementById('f-weight').value || 70,
  };
  setProfile(p);

  // æ›´æ–°â€œæˆ‘çš„â€å±•ç¤º
  document.getElementById('profile-name').textContent = p.name;
  document.getElementById('profile-basic').textContent = (p.gender||'') + (p.age?` ${p.age}å²`:'');
  document.getElementById('profile-body').textContent  = (p.height?`${p.height}cm`:'') + (p.weight?` / ${p.weight}kg`:'');
}

// è¥å…»ç›®æ ‡ï¼šæŠŠæœ¬åœ°æ•°æ® â†’ è¡¨å•
function loadGoalForm(){
  const gs = getGoalPresets();
  document.getElementById('g-high-cal').value   = gs.high.cal;
  document.getElementById('g-high-pro').value   = gs.high.pro;
  document.getElementById('g-high-fat').value   = gs.high.fat;
  document.getElementById('g-normal-cal').value = gs.normal.cal;
  document.getElementById('g-normal-pro').value = gs.normal.pro;
  document.getElementById('g-normal-fat').value = gs.normal.fat;
  document.getElementById('g-low-cal').value    = gs.low.cal;
  document.getElementById('g-low-pro').value    = gs.low.pro;
  document.getElementById('g-low-fat').value    = gs.low.fat;
}

// è¥å…»ç›®æ ‡ï¼šä¿å­˜è¡¨å• â†’ æœ¬åœ° & åˆ·æ–°é¦–é¡µæ˜¾ç¤º
function saveGoalForm(){
  const gs = {
    high:   { cal:+document.getElementById('g-high-cal').value   || 2500,
              pro:+document.getElementById('g-high-pro').value   || 120,
              fat:+document.getElementById('g-high-fat').value   || 80 },
    normal: { cal:+document.getElementById('g-normal-cal').value || 2000,
              pro:+document.getElementById('g-normal-pro').value || 100,
              fat:+document.getElementById('g-normal-fat').value || 65 },
    low:    { cal:+document.getElementById('g-low-cal').value    || 1500,
              pro:+document.getElementById('g-low-pro').value    || 80,
              fat:+document.getElementById('g-low-fat').value    || 50 },
  };
  setGoalPresets(gs);     // â† å†™å›
  loadGoalsForToday();    // â† ç”¨å½“å‰æ¨¡å¼çŒå…¥â€œä»Šæ—¥â€
  syncGoalLabels();       // â† åˆ·æ–°â€œé¦–é¡µâ€å’Œâ€œæˆ‘çš„â€å±•ç¤º
  updateStats();          // â† è¿›åº¦æ¡/å‰©ä½™
}

// æ‰“å¼€ä¸¤ç§è®¾ç½®é¡µ
function showProfileSettings(){ loadProfileForm(); switchTab('settingsProfile'); }
function showGoalSettings(){ loadGoalForm(); switchTab('settingsGoals'); }

// â€œæˆ‘çš„â€é¡µæŠŠå·²ä¿å­˜èµ„æ–™æ¸²æŸ“å‡ºæ¥
function loadProfile(){
  const p = getProfile();
  document.getElementById('profile-name').textContent = p.name || 'å¥åº·é¥®é£Ÿè€…';
  document.getElementById('profile-basic').textContent = (p.gender||'') + (p.age?` ${p.age}å²`:'');
  document.getElementById('profile-body').textContent  = (p.height?`${p.height}cm`:'') + (p.weight?` / ${p.weight}kg`:'');
}

// ç»‘å®šæŒ‰é’®ï¼šè¿”å›/ä¿å­˜ï¼ˆä¸¤ä¸ªå­é¡µï¼‰
document.getElementById('settings-back-profile').onclick = ()=> switchTab('profile');
document.getElementById('settings-save-profile').onclick = ()=>{
  saveProfileForm();
  alert('å·²ä¿å­˜');
  switchTab('profile');
};
document.getElementById('settings-back-goal').onclick = ()=> switchTab('profile');
document.getElementById('settings-save-goal').onclick = ()=>{
  saveGoalForm();
  alert('å·²ä¿å­˜');
  switchTab('profile');
};

// â€œæˆ‘çš„â€é¡µå…¥å£ï¼šåˆ†åˆ«è¿›å…¥ä¸¤ä¸ªå­é¡µ
document.getElementById('profile-edit').onclick     = () => showProfileSettings();
document.getElementById('profile-goal-btn').onclick = () => showGoalSettings();
      document.getElementById('tab-today').onclick = ()=>switchTab('today');
      document.getElementById('tab-history').onclick = ()=>switchTab('history');
      document.getElementById('tab-profile').onclick = ()=>switchTab('profile');
      document.getElementById('open-vip').onclick = () => {
  alert('å³å°†æ¨å‡ºï¼Œæ•¬è¯·æœŸå¾…');
};
      // ============== ä»Šå¤©é¡µé€»è¾‘ ==============
      document.getElementById('current-date').textContent = ymdKey(new Date());

// æ¨¡å¼åˆ‡æ¢ï¼ˆä»é¢„è®¾è¯»å–ï¼‰
const modeButtons = document.querySelectorAll('[data-mode]');
modeButtons.forEach(btn=>{
  btn.addEventListener('click',()=>{
    modeButtons.forEach(b=>b.classList.remove('bg-white','dark:bg-neutral-600','shadow-sm'));
    btn.classList.add('bg-white','dark:bg-neutral-600','shadow-sm');

    const mode = btn.getAttribute('data-mode');    // high / normal / low
    setCurrentMode(mode);
    const presets = getGoalPresets()[mode] || getGoalPresets().normal;

    document.getElementById('goal-cal').value = presets.cal;
    document.getElementById('goal-pro').value = presets.pro;
    document.getElementById('goal-fat').value = presets.fat;

    syncGoalLabels();
    saveTodayOverride(); // åªå¯¹å½“å¤©ç”Ÿæ•ˆ
  })
});

// â€œé‡ç½®ç›®æ ‡â€ = ç”¨å½“å‰æ¨¡å¼çš„é¢„è®¾å›å¡«ä»Šå¤©
document.getElementById('reset-goal').onclick = ()=>{
  const mode = getCurrentMode();
  const base = getGoalPresets()[mode] || getGoalPresets().normal;
  document.getElementById('goal-cal').value = base.cal;
  document.getElementById('goal-pro').value = base.pro;
  document.getElementById('goal-fat').value = base.fat;
  syncGoalLabels();
  saveTodayOverride();
};
      
function syncGoalLabels(){
  const cal = +document.getElementById('goal-cal').value || 2000;
  const pro = +document.getElementById('goal-pro').value || 100;
  const fat = +document.getElementById('goal-fat').value || 65;

  // æŒ‰å…¬å¼æ¨ç®—ç¢³æ°´ï¼šcarbs = (çƒ­é‡ - è›‹ç™½Ã—4 - è„‚è‚ªÃ—9) / 4
  let carbs = Math.round((cal - pro*4 - fat*9) / 4);
  if (!isFinite(carbs) || carbs < 0) carbs = 0;

  // â€”â€” é¦–é¡µå°å­—ï¼ˆç›®æ ‡ï¼‰â€”â€”
  document.getElementById('goal-pro-label').textContent  = pro;
  document.getElementById('goal-fat-label').textContent  = fat;
  const goalCarbsEl = document.getElementById('goal-carbs-label');
  if (goalCarbsEl) goalCarbsEl.textContent = carbs;

  // â€”â€” â€œæˆ‘çš„ â†’ è¥å…»ä¸ç›®æ ‡â€ä¸€è¡Œ â€”â€” 
  document.getElementById('profile-goal-cal').textContent   = cal;
  document.getElementById('profile-goal-pro').textContent   = pro;
  document.getElementById('profile-goal-fat').textContent   = fat;
  const profCarbsEl = document.getElementById('profile-goal-carbs');
  if (profCarbsEl) profCarbsEl.textContent = carbs;

  // â€”â€” åˆ·æ–°ä»Šæ—¥ç»Ÿè®¡ï¼ˆè¿›åº¦æ¡/å‰©ä½™ç­‰ï¼‰â€”â€”
  updateStats();
}

      // å¤œå®µ/åŠ é¤å¼€å…³ -> chipæ˜¾ç¤º
      const nightToggle = document.getElementById('night-snack');
      const nightChip = document.getElementById('night-snack-chip');
      nightToggle.addEventListener('change', () => {
  const off = !nightToggle.checked;
  nightChip.classList.toggle('hidden', off);
  nightChip.classList.toggle('opacity-50', off);
  nightChip.classList.toggle('pointer-events-none', off);
  nightChip.disabled = off;
  // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯å¤œå®µä½†è¢«å…³æ‰äº†ï¼Œé€€å›åˆ°â€œæ™šé¤â€
  if (off && currentMeal === 'night') setMeal('dinner');
});
      const snackToggle = document.getElementById('snack');
      const snackChip = document.getElementById('snack-chip');
      snackToggle.addEventListener('change', () => {
  const off = !snackToggle.checked;
  snackChip.classList.toggle('hidden', off);
  snackChip.classList.toggle('opacity-50', off);
  snackChip.classList.toggle('pointer-events-none', off);
  snackChip.disabled = off;
  if (off && currentMeal === 'snack') setMeal('dinner');
});
// â€”â€” é¤æ¬¡é€‰æ‹© â€”â€”
// å½“å‰é€‰æ‹©çš„é¤æ¬¡ï¼šbreakfast / lunch / dinner / night / snack
let currentMeal = 'dinner';

const mealChipEls = {
  breakfast: document.getElementById('breakfast-chip'),
  lunch:     document.getElementById('lunch-chip'),
  dinner:    document.getElementById('dinner-chip'),
  night:     document.getElementById('night-snack-chip'),
  snack:     document.getElementById('snack-chip'),
};

function setMeal(meal) {
  currentMeal = meal;
  // æ¸…é™¤å…¨éƒ¨çš„â€œé€‰ä¸­æ ·å¼â€
  Object.values(mealChipEls).forEach(el => {
    if (!el) return;
    el.classList.remove('bg-primary','text-white');
    // æ¢å¤æœªé€‰ä¸­çš„åŸºç¡€æ ·å¼
    if (!el.classList.contains('hidden')) {
      el.classList.add('bg-neutral-100','dark:bg-neutral-700');
    }
  });
  // ç»™å½“å‰é€‰ä¸­çš„åŠ é«˜äº®
  const el = mealChipEls[meal];
  if (el && !el.disabled) {
    el.classList.remove('bg-neutral-100','dark:bg-neutral-700');
    el.classList.add('bg-primary','text-white');
  }
}

// ç»‘å®šç‚¹å‡»
Object.entries(mealChipEls).forEach(([key, el]) => {
  if (!el) return;
  el.addEventListener('click', () => {
    if (el.disabled) return;
    setMeal(key);
  });
});

// åˆå§‹è®¾ä¸ºâ€œæ™šé¤â€
setMeal('dinner');

      // å·²ç§»é™¤å¥åº·æ£€æŸ¥åŠŸèƒ½ï¼Œç›´æ¥è°ƒç”¨é€šä¹‰åƒé—®API

      // AI å¼¹å±‚
      document.getElementById('camera-btn').onclick = ()=> {
        photoInput.click();
      };
      document.getElementById('save-meal-btn').onclick = ()=>{
  // æ–‡å­—è¯†åˆ«å…¥å£ï¼šå½»åº•æ¸…æ‰ä¸Šä¸€å¼ å›¾ç‰‡çŠ¶æ€
  selectedImageData = null;
  const preview = document.getElementById('ai-preview-img');
  if (preview) {
    preview.src = '';
    preview.classList.add('hidden');
  }
  // æ¸…ç©ºä¸Šä¸€æ¬¡ä¿®æ­£å£ä»¤ï¼Œé¿å…ä¸²åœº
  const corr = document.getElementById('ai-correction');
  if (corr) corr.value = '';

  // æ‰“å¼€å¼¹çª—å¹¶æŒ‰"çº¯æ–‡å­—"æ‰§è¡Œä¸€æ¬¡
  aiModal.classList.remove('hidden');
  runAOnce();
};
      // "çº¸é£æœº"å‘é€ï¼šæŠŠä¿®æ­£è¯´æ˜å¸¦ä¸Šï¼Œå†è¯†åˆ«ä¸€æ¬¡å¹¶åˆ·æ–°è¡¨æ ¼
document.getElementById('ai-send').onclick = ()=>{
  const note = document.getElementById('ai-correction').value || '';
  if (note.trim()) {
    runAOnce(note);
  }
};

// ä¿®æ­£æŒ‡ä»¤è¾“å…¥æ¡†å›è½¦é”®æ”¯æŒ
document.getElementById('ai-correction').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const note = e.target.value || '';
    if (note.trim()) {
      runAOnce(note);
    }
  }
});
// ç›‘å¬ç”¨æˆ·é€‰å›¾/æ‹ç…§
const previewEl = document.getElementById('ai-preview-img');
if (previewEl) {
  previewEl.src = selectedImageData || '';
  previewEl.classList.toggle('hidden', !selectedImageData);
}
// ä»…å½“æ˜¯æ‹ç…§/é€‰å›¾å…¥å£æ—¶æ‰æ‰“å¼€å¼¹å±‚
      // ç•™å¥½ Netlify ä¸­è½¬ã€Œå£å­ã€
// === ç³»ç»Ÿè§„åˆ™ï¼ˆä¼ ç»™åç«¯/å¤§æ¨¡å‹çš„ system æˆ–æ‹¼è¿› textï¼‰ ===
// â€”â€” æ¢å¤â€œä¸¥æ ¼ JSON å¥‘çº¦â€ï¼šitems + totals + notes â€”â€”
// è¯´æ˜ï¼škcal æ•´æ•°ï¼›å…¶ä½™ä¸€ä½å°æ•°ï¼›totals å¿…é¡»ä¸º items æ±‚å’Œï¼›ä¸­æ–‡èœå



// â€”â€” é€€é¿é‡è¯• â€”â€” 
async function withBackoff(doReq, tries=3, delay=6000){
  let lastErr;
  for (let i=0;i<tries;i++){
    try { return await doReq(); }
    catch(e){
      const msg = String(e?.message||"");
      const is429 = (e && e.status===429) || /rate limit/i.test(msg);
      lastErr = e;
      if (is429 && i < tries-1) await new Promise(r=>setTimeout(r,delay));
      else break;
    }
  }
  throw lastErr || new Error("request failed");
}

// â€”â€” ä¸¥æ ¼è§£æ + äºŒæ¬¡æ±‚å’Œå…œåº• â€”â€” 
function safeParseJSON(txt){
  try{
    const obj = JSON.parse(txt);
    const items = Array.isArray(obj.items)? obj.items.map(x=>({
      name: String(x.name||'é£Ÿç‰©'),
      kcal: Math.max(0, Math.round(Number(x.kcal)||0)),
      protein: Number(x.protein??0),
      fat: Number(x.fat??0),
      carbs: Number(x.carbs??0),
    })) : [];

    const totals = items.reduce((a,i)=>({
      kcal:a.kcal+i.kcal,
      protein:+(a.protein+i.protein).toFixed(1),
      fat:+(a.fat+i.fat).toFixed(1),
      carbs:+(a.carbs+i.carbs).toFixed(1),
    }), {kcal:0,protein:0,fat:0,carbs:0});

    const out = {
      items,
      totals,
      notes: typeof obj.notes==='string' ? obj.notes : ''
    };
    return out;
  }catch{
    throw new Error('æ¨¡å‹è¿”å›æ ¼å¼å¼‚å¸¸ï¼šä¸æ˜¯åˆæ³•JSON');
  }
}




// â€”â€” ä¼šè¯æ€ï¼ˆå½“å‰å¼¹å±‚çš„ä¸€æ¬¡ä¼šè¯ï¼‰ï¼šä¿ç•™ lastJSON & å†å²æ¶ˆæ¯ â€”â€” 
// window.__aiSession = { lastJSON, messages: [{role:'assistant'|'user', payload|text, ts}], img?:string|null }


// â€”â€” æ¸²æŸ“è¯†åˆ«ç»“æœï¼ˆå¯ç¼–è¾‘ç‰ˆæœ¬ï¼šé€é¡¹ + åˆè®¡ + notesï¼‰ â€”â€” 
function renderAiResult(json){
  const wrap = document.getElementById('ai-table');
  wrap.innerHTML = '';
  const items = Array.isArray(json?.items) ? json.items : [];
  
  // å­˜å‚¨å½“å‰ç¼–è¾‘çš„æ•°æ®
  window.currentEditableItems = [...items];
  
  items.forEach((it, index)=>{
    const p=+(it.protein||0), c=+(it.carbs||0), f=+(it.fat||0);
    const kcal = Math.max(0, Math.round(+it.kcal||0));
    const row = document.createElement('div');
    row.className = 'p-3 rounded-xl bg-neutral-50 dark:bg-neutral-700 mb-2';
    row.innerHTML = `
      <div class="flex justify-between items-center mb-2">
        <div class="font-medium flex-1">${it.name || 'é£Ÿç‰©'}</div>
        <button class="ml-2 px-2 py-1 text-xs text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded" 
                onclick="removeItem(${index})">åˆ é™¤</button>
      </div>
      <div class="grid grid-cols-2 gap-3 text-sm">
        <div>
          <label class="text-xs text-neutral-500 dark:text-neutral-400">ä»½é‡è°ƒèŠ‚</label>
          <div class="flex items-center gap-2 mt-1">
            <button class="w-6 h-6 rounded bg-neutral-200 dark:bg-neutral-600 text-xs" 
                    onclick="adjustQuantity(${index}, 0.5)">-</button>
            <span class="quantity-display text-sm font-medium" data-index="${index}">1.0ä»½</span>
            <button class="w-6 h-6 rounded bg-neutral-200 dark:bg-neutral-600 text-xs" 
                    onclick="adjustQuantity(${index}, 2)">+</button>
          </div>
        </div>
        <div class="text-right">
          <div class="text-lg font-medium kcal-display" data-index="${index}">${kcal} kcal</div>
          <div class="text-xs text-neutral-500 dark:text-neutral-400">
            è›‹ç™½ <span class="protein-display" data-index="${index}">${p.toFixed(1)}</span>g | 
            ç¢³æ°´ <span class="carbs-display" data-index="${index}">${c.toFixed(1)}</span>g | 
            è„‚è‚ª <span class="fat-display" data-index="${index}">${f.toFixed(1)}</span>g
          </div>
        </div>
      </div>
    `;
    wrap.appendChild(row);
  });

  updateTotalDisplay();

  // å¯é€‰ notes
  if (json?.notes) {
    const n = document.createElement('div');
    n.className = 'mt-2 text-xs text-neutral-500 dark:text-neutral-400';
    n.textContent = 'notesï¼š' + json.notes;
    wrap.appendChild(n);
  }
}

// â€”â€” ç¼–è¾‘åŠŸèƒ½ï¼šåˆ é™¤é£Ÿç‰©é¡¹ â€”â€”
function removeItem(index) {
  if (!window.currentEditableItems || index >= window.currentEditableItems.length) return;
  
  // ä»æ•°ç»„ä¸­åˆ é™¤è¯¥é¡¹
  window.currentEditableItems.splice(index, 1);
  
  // é‡æ–°æ¸²æŸ“
  const json = {
    items: window.currentEditableItems,
    totals: calcTotals(window.currentEditableItems),
    notes: ''
  };
  renderAiResult(json);
  
  // æ›´æ–°ä¼šè¯æ•°æ®
  if (window.__aiSession) {
    window.__aiSession.lastJSON = json;
  }
}

// â€”â€” ç¼–è¾‘åŠŸèƒ½ï¼šè°ƒèŠ‚ä»½é‡ â€”â€”
function adjustQuantity(index, multiplier) {
  if (!window.currentEditableItems || index >= window.currentEditableItems.length) return;
  
  const item = window.currentEditableItems[index];
  if (!item.originalValues) {
    // é¦–æ¬¡è°ƒèŠ‚æ—¶ä¿å­˜åŸå§‹å€¼
    item.originalValues = {
      protein: item.protein,
      carbs: item.carbs,
      fat: item.fat,
      kcal: item.kcal
    };
    item.currentMultiplier = 1.0;
  }
  
  // æ›´æ–°å€æ•°
  if (multiplier === 0.5) {
    item.currentMultiplier = Math.max(0.1, item.currentMultiplier - 0.1);
  } else if (multiplier === 2) {
    item.currentMultiplier = Math.min(5.0, item.currentMultiplier + 0.1);
  }
  
  // æ ¹æ®å€æ•°é‡æ–°è®¡ç®—è¥å…»æˆåˆ†
  const original = item.originalValues;
  item.protein = +(original.protein * item.currentMultiplier).toFixed(1);
  item.carbs = +(original.carbs * item.currentMultiplier).toFixed(1);
  item.fat = +(original.fat * item.currentMultiplier).toFixed(1);
  item.kcal = Math.round(original.kcal * item.currentMultiplier);
  
  // æ›´æ–°æ˜¾ç¤º
  updateItemDisplay(index, item);
  updateTotalDisplay();
  
  // æ›´æ–°ä¼šè¯æ•°æ®
  if (window.__aiSession) {
    window.__aiSession.lastJSON = {
      items: window.currentEditableItems,
      totals: calcTotals(window.currentEditableItems),
      notes: ''
    };
  }
}

// â€”â€” æ›´æ–°å•ä¸ªé£Ÿç‰©é¡¹çš„æ˜¾ç¤º â€”â€”
function updateItemDisplay(index, item) {
  const quantityEl = document.querySelector(`.quantity-display[data-index="${index}"]`);
  const kcalEl = document.querySelector(`.kcal-display[data-index="${index}"]`);
  const proteinEl = document.querySelector(`.protein-display[data-index="${index}"]`);
  const carbsEl = document.querySelector(`.carbs-display[data-index="${index}"]`);
  const fatEl = document.querySelector(`.fat-display[data-index="${index}"]`);
  
  if (quantityEl) quantityEl.textContent = `${item.currentMultiplier.toFixed(1)}ä»½`;
  if (kcalEl) kcalEl.textContent = `${item.kcal} kcal`;
  if (proteinEl) proteinEl.textContent = item.protein.toFixed(1);
  if (carbsEl) carbsEl.textContent = item.carbs.toFixed(1);
  if (fatEl) fatEl.textContent = item.fat.toFixed(1);
}

// â€”â€” æ›´æ–°æ€»è®¡æ˜¾ç¤º â€”â€”
function updateTotalDisplay() {
  if (!window.currentEditableItems) return;
  
  const totals = calcTotals(window.currentEditableItems);
  const totalEl = document.getElementById('ai-total');
  if (totalEl) {
    totalEl.textContent = totals.kcal + 'kcal';
  }
}

// â€”â€” å•æ¬¡è¿è¡Œï¼šå›¾ç‰‡/æ–‡å­—é¦–è½®è¯†åˆ«ï¼›æˆ–åŸºäºä¸Šä¸€è½® JSON çš„"ä¿®æ­£" â€”â€” 
async function runAOnce(extraText){
  const baseText = (document.getElementById('meal-text')?.value || '').trim();
  const fixText  = (extraText || (document.getElementById('ai-correction')?.value||'')).trim();
  const hasImage = !!selectedImageData;

  // é¢„è§ˆ
  const preview = document.getElementById('ai-preview-img');
  if (preview) {
    if (hasImage) { preview.src = selectedImageData; preview.classList.remove('hidden'); }
    else { preview.src = ''; preview.classList.add('hidden'); }
  }

  const table = document.getElementById('ai-table');
  table.innerHTML = `<div class="text-sm text-neutral-500">è¯†åˆ«ä¸­...</div>`;
  document.getElementById('ai-total').textContent = '0kcal';

  try{
    let json;

    // ä¿®æ­£é€šè·¯ï¼šæœ‰ä¿®æ­£æ–‡å­—æŒ‡ä»¤
    if (fixText && (window.__aiSession?.lastJSON || window.currentEditableItems)) {
      // è·å–å½“å‰çš„é£Ÿç‰©æ•°æ®ï¼ˆä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ç¼–è¾‘è¿‡çš„æ•°æ®ï¼‰
      const currentData = window.currentEditableItems && window.currentEditableItems.length > 0 
        ? window.currentEditableItems 
        : (window.__aiSession?.lastJSON?.items || []);
      
      const currentJSON = {
        items: currentData,
        totals: calcTotals(currentData),
        notes: ''
      };

      console.log('åŸºäºå½“å‰æ•°æ®è¿›è¡Œä¿®æ­£:', currentJSON);
      
      const text = `å½“å‰é£Ÿç‰©æ¸…å•JSONï¼š\n${JSON.stringify(currentJSON)}\n\nç”¨æˆ·ä¿®æ­£æŒ‡ä»¤ï¼š${fixText}\n\nè¯·æ ¹æ®ç”¨æˆ·æŒ‡ä»¤ä¿®æ”¹é£Ÿç‰©æ¸…å•ï¼Œæ¯”å¦‚åˆ é™¤ä¸è¦çš„é£Ÿç‰©ã€ä¿®æ”¹ä»½é‡ç­‰ï¼Œè¿”å›ä¿®æ­£åçš„ä¸¥æ ¼JSONã€‚`;
      json = await callAI({ text, image:null, mode:'revise', prevJSON: currentJSON });

      window.__aiSession = {
        ...(window.__aiSession||{}),
        lastJSON: json,
        messages: [
          ...((window.__aiSession?.messages)||[]),
          { role:'user', text: fixText, ts: Date.now() },
          { role:'assistant', payload: json, ts: Date.now() },
        ]
      };
    } else {
      // é¦–è½®ï¼šæœ‰å›¾ä¼˜å…ˆçœ‹å›¾ï¼›å¦åˆ™çœ‹çº¯æ–‡å­—
      if (hasImage) {
        // å¯æŠŠä¿®æ­£å£ä»¤æ‹¼è¿›æ–‡å­—ï¼Œè®©åç«¯ä¸€å¹¶å‚è€ƒ
        const text = fixText ? `ä¿®æ­£æŒ‡ä»¤ï¼š${fixText}` : (baseText || null);
        json = await callAI({ text, image: selectedImageData, mode:'image' });
        window.__aiSession = { lastJSON: json, img: selectedImageData, messages: [{ role:'assistant', payload: json, ts: Date.now() }] };
      } else {
        const text = baseText || (fixText ? `ä¿®æ­£æŒ‡ä»¤ï¼š${fixText}` : '');
        json = await callAI({ text, image: null, mode:'text' });
        window.__aiSession = { lastJSON: json, img: null, messages: [{ role:'assistant', payload: json, ts: Date.now() }] };
      }

      // å¦‚æœé¦–è½®åè¿˜æœ‰ä¿®æ­£å£ä»¤ï¼Œå†èµ°ä¸€é"ä¿®æ­£"
      if (!hasImage && fixText) {
        const revised = await callAI({
          text: `å½“å‰é£Ÿç‰©æ¸…å•JSONï¼š\n${JSON.stringify(json)}\n\nç”¨æˆ·ä¿®æ­£æŒ‡ä»¤ï¼š${fixText}\n\nè¯·æ ¹æ®ç”¨æˆ·æŒ‡ä»¤ä¿®æ”¹é£Ÿç‰©æ¸…å•ï¼Œè¿”å›ä¿®æ­£åçš„ä¸¥æ ¼JSONã€‚`,
          image: null, mode:'revise', prevJSON: json
        });
        json = revised;
        window.__aiSession = {
          ...(window.__aiSession||{}),
          lastJSON: revised,
          messages: [
            ...((window.__aiSession?.messages)||[]),
            { role:'user', text: fixText, ts: Date.now() },
            { role:'assistant', payload: revised, ts: Date.now() }
          ]
        };
      }
    }

    const show = window.__aiSession?.lastJSON;
    if (!show || !Array.isArray(show.items) || show.items.length===0){
      table.innerHTML = `<div class="text-sm text-neutral-500">æ²¡æœ‰è¯†åˆ«åˆ°æœ‰æ•ˆé£Ÿç‰©ï¼š<br/>Â· çº¯æ–‡å­—å°½é‡ã€Œé£Ÿç‰© + åšæ³• + ä»½é‡ã€<br/>Â· ç…§ç‰‡è¯·ä¿¯æ‹ã€å…‰çº¿å……è¶³ï¼Œå†è¯•ä¸€æ¬¡</div>`;
      document.getElementById('ai-total').textContent = '0kcal';
      return;
    }

    // æ¸²æŸ“ä¸¥æ ¼ JSONï¼ˆä¿ç•™çš„é‚£ä¸€ç‰ˆï¼‰
    renderAiResult(show);
    
    // æ¸…ç©ºä¿®æ­£æŒ‡ä»¤è¾“å…¥æ¡†
    const correctionInput = document.getElementById('ai-correction');
    if (correctionInput) correctionInput.value = '';
    
  }catch(err){
    table.innerHTML = `<div class="text-sm text-red-500">AI è°ƒç”¨å¤±è´¥ï¼š${err?.message || 'è¯·ç¨åå†è¯•'}</div>`;
    alert('AI è°ƒç”¨å¤±è´¥ï¼š' + (err?.message || 'è¯·ç¨åå†è¯•'));
    console.error('[AI è°ƒç”¨å¤±è´¥]', err);
  }
}


      // ç¡®è®¤AI -> ä¿å­˜åˆ°æœ¬åœ°
document.getElementById('confirm-ai').onclick = () => {
  // 1) ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ä¿®æ­£åçš„æ•°æ®
  let fin = [];
  let totals = {kcal:0,protein:0,carbs:0,fat:0};

  if (window.currentEditableItems && window.currentEditableItems.length > 0) {
    // ä½¿ç”¨ç”¨æˆ·ä¿®æ­£åçš„æ•°æ®
    fin = window.currentEditableItems.map(it=>({
      name: String(it.name||'é£Ÿç‰©'),
      protein: +(it.protein||0),
      carbs: +(it.carbs||0),
      fat: +(it.fat||0),
      kcal: Math.max(0, Math.round(+it.kcal||0))
    }));
    totals = calcTotals(fin);
  } else {
    // 2) å…œåº•ï¼šä½¿ç”¨ä¼šè¯æ€æ•°æ®
    const j = (window.__aiSession && window.__aiSession.lastJSON) || null;
    
    if (j && Array.isArray(j.items) && j.items.length>0) {
      fin = j.items.map(it=>({
        name: String(it.name||'é£Ÿç‰©'),
        protein: +(it.protein||0),
        carbs: +(it.carbs||0),
        fat: +(it.fat||0),
        kcal: Math.max(0, Math.round(+it.kcal||0))
      }));
      totals = {
        kcal: Math.max(0, Math.round(+j.totals?.kcal||0)),
        protein: +(+j.totals?.protein||0).toFixed(1),
        carbs: +(+j.totals?.carbs||0).toFixed(1),
        fat: +(+j.totals?.fat||0).toFixed(1),
      };
    }
  }

  if (fin.length === 0) {
    alert('æ²¡æœ‰å¯ä¿å­˜çš„æ¡ç›®');
    return;
  }

  const meals = store.get('meals', []);
  if (editingOldMealKey) {
    const idx = meals.findIndex(x => x.time === editingOldMealKey);
    if (idx > -1) {
      meals[idx].items = fin;
meals[idx].text = formatMealText(fin);   // ç”¨ â€œé£Ÿç‰© x æ•°é‡â€ ç®€è¿°æ–‡æ¡ˆ
meals[idx].totals = totals;
      meals[idx].updatedAt = Date.now();
      store.set('meals', meals);
      loadGoalsForToday();
      syncGoalLabels();
      paintMeals();
    }
    editingOldMealKey = null;
    tempAiItemsForEdit = null;
  } else {
    // åŸæ¥æ˜¯ä» textarea å– textï¼Œè¿™é‡Œæ”¹æˆä½¿ç”¨ formatMealText ç”Ÿæˆçš„ç®€è¿°
const entry = {
  time: Date.now(),
  mealType: currentMeal,
  text: formatMealText(fin),   // å…³é”®ï¼šä¿å­˜ä¸º â€œç‰›è‚‰é¢ x 1, é¦™è•‰ x 1â€
  items: fin,
  totals
};
    meals.push(entry);
    document.getElementById('meal-text').value = '';
    store.set('meals', meals);
    paintMeals();
    updateStats();
  }

  // æœ€åå†å…³é—­å¼¹å±‚å¹¶æ¸…ç†ä¼šè¯
  closeAiModal();
};
 




      // æ¸²æŸ“ä»Šæ—¥åˆ—è¡¨
      // æ¸²æŸ“ä»Šæ—¥åˆ—è¡¨
      function paintMeals(){
  const list = document.getElementById('meals-list');
  const all = store.get('meals', []);

  const todayKey = ymdKey(new Date());
  const meals = all.filter(m => ymdKey(new Date(m.time)) === todayKey);

  list.innerHTML = '';
  if(meals.length===0){
    document.getElementById('empty-state-today').classList.remove('hidden');
    return;
  }
  document.getElementById('empty-state-today').classList.add('hidden');

  // é¤æ¬¡ä¸­æ–‡åæ˜ å°„
  const MEAL_NAME = {
    breakfast: 'æ—©é¤',
    lunch: 'åˆé¤',
    dinner: 'æ™šé¤',
    night: 'å¤œå®µ',
    snack: 'åŠ é¤'
  };

  meals.slice().reverse().forEach((m)=>{
    const when = new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    const mealName = MEAL_NAME[m.mealType] || 'â€”';

    const card = document.createElement('div');
    card.className = 'bg-white dark:bg-neutral-800 rounded-xl shadow-light p-5 border border-neutral-200 dark:border-neutral-700 transition-transform-shadow';

    // è¿™é‡ŒæŠŠã€Œé¤æ¬¡åã€åšæˆå°åœ†è§’æ ‡ç­¾æ”¾åœ¨æ—¶é—´æ—è¾¹
    card.innerHTML = `
      <div class='flex justify-between items-start'>
        <div>
          <div class='flex items-center gap-2 mb-1'>
            <span class='px-2 py-0.5 rounded-full bg-neutral-100 dark:bg-neutral-700 text-xs'>${mealName}</span>
            <span class='font-medium text-sm'>${when}</span>
          </div>
          <div class='text-xs text-neutral-500 dark:text-neutral-400'>${m.text}</div>
        </div>
        <button class='touch-target p-2 text-neutral-400 hover:text-red-500' data-del='1'>
          <i class='fa-solid fa-trash-alt'></i>
        </button>
      </div>
      <div class='mt-2 text-xs text-neutral-500 dark:text-neutral-400 space-x-2 flex flex-wrap'>
        <span>${m.totals.kcal}kcal</span>
        <span>è›‹ç™½è´¨${m.totals.protein}</span>
        <span>ç¢³æ°´${m.totals.carbs}</span>
        <span>è„‚è‚ª${m.totals.fat}</span>
      </div>`;

    card.querySelector('[data-del]')?.addEventListener('click',()=>{
      const all = store.get('meals', []);
      const idx = all.findIndex(x=>x.time===m.time);
      if(idx>-1){ all.splice(idx,1); store.set('meals', all); paintMeals(); updateStats(); }
    });

    list.appendChild(card);
  });
}

      // ç»Ÿè®¡æ±‡æ€»
      function updateStats(){
  const all = store.get('meals', []);
  const todayKey = ymdKey(new Date());
  const meals = all.filter(m => ymdKey(new Date(m.time)) === todayKey);

  const totals = meals.reduce((a,m)=>({
    kcal:   a.kcal   + (m.totals?.kcal   || 0),
    protein:a.protein+ (m.totals?.protein|| 0),
    carbs:  a.carbs  + (m.totals?.carbs  || 0),
    fat:    a.fat    + (m.totals?.fat    || 0)
  }), {kcal:0,protein:0,carbs:0,fat:0});

  const goalCal = +document.getElementById('goal-cal').value || 2000;
  const goalPro = +document.getElementById('goal-pro').value || 100;
  const goalFat = +document.getElementById('goal-fat').value || 65;
  let goalCarbs = Math.round((goalCal - goalPro*4 - goalFat*9) / 4);
  if (!isFinite(goalCarbs) || goalCarbs < 0) goalCarbs = 0;
  const goalCarbsEl = document.getElementById('goal-carbs-label');
  if (goalCarbsEl) goalCarbsEl.textContent = goalCarbs;

  // è®¡ç®—å‰©ä½™
  const remainCal = Math.max(0, goalCal - totals.kcal);
  const remainPro = Math.max(0, goalPro - totals.protein);
  const remainCar = Math.max(0, goalCarbs - totals.carbs);
  const remainFat = Math.max(0, goalFat - totals.fat);

  // çƒ­é‡è¿›åº¦ + æ–‡æ¡ˆâ€œå·²/ç›®/å‰©â€
  const calPct = goalCal ? Math.min(100, Math.round((totals.kcal/goalCal)*100)) : 0;
  const calText = `${totals.kcal} / ${goalCal} kcalï¼ˆå‰©ä½™ ${remainCal}ï¼‰`;
  document.getElementById('calories-progress').textContent = calText;
  document.getElementById('calories-bar').style.width = calPct + '%';

  // æ•°å­—æ˜¾ç¤º
  document.getElementById('stat-protein').textContent = `${(totals.protein||0).toFixed(1)} gï¼ˆå‰© ${remainPro.toFixed(1)}ï¼‰`;
  document.getElementById('stat-carbs').textContent   = `${(totals.carbs||0).toFixed(1)} gï¼ˆå‰© ${remainCar.toFixed(1)}ï¼‰`;
  document.getElementById('stat-fat').textContent     = `${(totals.fat||0).toFixed(1)} gï¼ˆå‰© ${remainFat.toFixed(1)}ï¼‰`;

  // è¿›åº¦æ¡
  const proPct  = goalPro   ? Math.min(100, Math.round((totals.protein/goalPro)*100)) : 0;
  const carbPct = goalCarbs ? Math.min(100, Math.round((totals.carbs/goalCarbs)*100)) : 0;
  const fatPct  = goalFat   ? Math.min(100, Math.round((totals.fat/goalFat)*100))     : 0;
  const proBar  = document.getElementById('protein-bar');
  const carbBar = document.getElementById('carbs-bar');
  const fatBar  = document.getElementById('fat-bar');
  if (proBar)  proBar.style.width  = proPct  + '%';
  if (carbBar) carbBar.style.width = carbPct + '%';
  if (fatBar)  fatBar.style.width  = fatPct  + '%';
}
loadGoalsForToday();
syncGoalLabels();
paintMeals();

      // ============== å†å²é¡µï¼ˆå‘¨/æœˆè§†å›¾ + æ—¥å† + å½“å¤©è¯¦æƒ… + ç¼–è¾‘ï¼‰ ==============

// å°å·¥å…·
const MEAL_I18N = { breakfast:'æ—©é¤', lunch:'åˆé¤', dinner:'æ™šé¤', night:'å¤œå®µ', snack:'åŠ é¤' };
const MEAL_ORDER = ['breakfast','lunch','dinner','snack','night'];

const two = n => n < 10 ? '0'+n : ''+n;
const ymd = d => `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`;
const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
const startOfWeek = (d) => { // å‘¨ä¸€ä¸ºä¸€å‘¨å¼€å§‹
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const wd = (x.getDay() + 6) % 7; // 0..6 => Mon..Sun
  x.setDate(x.getDate() - wd);
  return x;
};
const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
const endOfMonth = (d) => new Date(d.getFullYear(), d.getMonth()+1, 0);

const getMeals = () => store.get('meals', []);
const mealsOfDate = (date) => {
  const key = ymd(date);
  return getMeals().filter(m => ymd(new Date(m.time)) === key);
};
const totalsOfDate = (date) => {
  const arr = mealsOfDate(date);
  return arr.reduce((a,m)=>({
    kcal:a.kcal+(m.totals?.kcal||0),
    protein:a.protein+(m.totals?.protein||0),
    carbs:a.carbs+(m.totals?.carbs||0),
    fat:a.fat+(m.totals?.fat||0),
  }), {kcal:0,protein:0,carbs:0,fat:0});
};

// å†å²é¡µçŠ¶æ€
let historyView = 'week';                   // 'week' | 'month'
let periodStart = startOfWeek(new Date());  // å‘¨è§†å›¾ï¼šæ‰€åœ¨å‘¨å‘¨ä¸€ï¼›æœˆè§†å›¾ï¼šæ‰€åœ¨æœˆ 1 å·
let selectedDate = new Date();              // å½“å‰é€‰ä¸­çš„å…·ä½“å“ªä¸€å¤©

function initHistory(){
  // è¿›å…¥å†å²é¡µæ—¶ï¼Œåˆ·æ–°çŠ¶æ€ï¼ˆä¿è¯â€œä¸‹ä¸€æœŸâ€ä¸ä¼šè¶Šè¿‡ä»Šå¤©ï¼‰
  const weekActive  = document.getElementById('btn-week')?.classList.contains('bg-white');
const monthActive = document.getElementById('btn-month')?.classList.contains('bg-white');
if (weekActive)  historyView = 'week';
if (monthActive) historyView = 'month';
  periodStart = historyView === 'week' ? startOfWeek(selectedDate) : startOfMonth(selectedDate);
// ========= å†å²é¤è¯¦æƒ…å¼¹å±‚ =========
const hmModal  = document.getElementById('hist-meal-modal');
const hmClose  = document.getElementById('hm-close');
const hmItems  = document.getElementById('hm-items');
let   hmEditingKey = null;

function openHistMealModal(mealKey){
  const all = store.get('meals', []);
  const m = all.find(x=>x.time===mealKey);
  if(!m) return;
  hmEditingKey = mealKey;

  const titleMap = {breakfast:'æ—©é¤', lunch:'åˆé¤', dinner:'æ™šé¤', night:'å¤œå®µ', snack:'åŠ é¤'};
  document.getElementById('hm-title').textContent = (titleMap[m.mealType]||'é¤') + 'è¯¦æƒ…';
  const d = new Date(m.time);
  const two = n => n<10?'0'+n:''+n;
  document.getElementById('hm-date').textContent = `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`;
  document.getElementById('hm-note').value = m.note || '';

  // æ¸²æŸ“æ¯ä¸ªé£Ÿç‰©æ¡ç›®ä¸ºåªè¯»è¡Œ
hmItems.innerHTML = '';
(m.items || []).forEach((it) => {
  const row = document.createElement('div');
  row.className = 'p-3 rounded-xl bg-neutral-50 dark:bg-neutral-700';
  row.innerHTML = `
    <div class="flex justify-between items-center">
      <div class="font-medium">${it.name || ''}</div>
      <div class="text-sm text-neutral-500">${it.kcal || 0}kcal</div>
    </div>`;
  hmItems.appendChild(row);
});

// ğŸ‘‰ æ–°å¢ï¼šè®¡ç®—å¹¶æ›´æ–°æœ¬é¤æ€»è®¡
const total = m.totals || { kcal: 0, protein: 0, carbs: 0, fat: 0 };
document.getElementById('hm-total-kcal').textContent = total.kcal + ' kcal';
document.getElementById('hm-total-pro').textContent = total.protein;
document.getElementById('hm-total-carb').textContent = total.carbs;
document.getElementById('hm-total-fat').textContent = total.fat;

// ä¿®æ”¹ä¿å­˜æŒ‰é’®æ–‡æ¡ˆ
document.getElementById('hm-save').textContent = 'è®© AI ç”Ÿæˆæ–°çš„ä¸€é¤';
  hmModal.classList.remove('hidden');
  hmModal.classList.add('flex');
}
window.openHistMealModal = openHistMealModal;

function recalcModalTotals(){
  const all = store.get('meals', []);
  const m = all.find(x=>x.time===hmEditingKey);
  if(!m) return;

  let sum = {k:0,p:0,c:0,f:0};
  (m.items||[]).forEach((it, idx)=>{
    const p = +document.querySelector(`[data-edit="${idx}-p"]`)?.value || 0;
    const c = +document.querySelector(`[data-edit="${idx}-c"]`)?.value || 0;
    const f = +document.querySelector(`[data-edit="${idx}-f"]`)?.value || 0;
    const kcal = Math.round(p*4 + c*4 + f*9);
    const kcalSpan = document.querySelector(`[data-k="${idx}-kcal"]`);
    if(kcalSpan) kcalSpan.textContent = kcal;
    sum.k += kcal; sum.p += p; sum.c += c; sum.f += f;
  });
  document.getElementById('hm-total-kcal').textContent = `${sum.k}kcal`;
  document.getElementById('hm-total-pro').textContent  = sum.p.toFixed(1);
  document.getElementById('hm-total-carb').textContent = sum.c.toFixed(1);
  document.getElementById('hm-total-fat').textContent  = sum.f.toFixed(1);
}

hmClose.onclick = ()=> hmModal.classList.add('hidden');

document.getElementById('hm-save').onclick = async () => {
  const all = store.get('meals', []);
  const m = all.find(x => x.time === hmEditingKey);
  if (!m) return;

  // ç»„åˆç»™AIçš„è¾“å…¥ï¼šåŸå§‹æ–‡æœ¬ + ä¿®æ­£è¯´æ˜
  const note = (document.getElementById('hm-note').value || '').trim();
  const aiInput = (m.text || '') + (note ? ('ï¼›ä¿®æ­£è¯´æ˜ï¼š' + note) : '');

  let ret;
  try {
    ret = await callAI({ text: aiInput, image: null, mode:'text' });
  } catch (e) {
    alert('AI ç”Ÿæˆå¤±è´¥ï¼š' + (e?.message || 'è¯·ç¨åé‡è¯•'));
    return;
  }

  const items = Array.isArray(ret?.items) ? ret.items : [];
  if (items.length === 0) {
    alert('AI æœªç”Ÿæˆæœ‰æ•ˆæ¡ç›®ï¼Œè¯·è°ƒæ•´ä¿®æ­£è¯´æ˜å†è¯•ã€‚');
    return;
  }

  // æŠŠAIç»“æœé¢„æ¸²æŸ“åˆ° ai-modal çš„è¡¨æ ¼ï¼ˆå¯ç»§ç»­æ‹–åŠ¨æ»‘æ†å¾®è°ƒï¼‰
  const json = { items, totals: calcTotals(items), notes: ret?.notes || '' };
renderAiResult(json);
  tempAiItemsForEdit = items;
  editingOldMealKey = hmEditingKey;

  // æ‰“å¼€ ai-modal è®©ä½ ç¡®è®¤
  document.getElementById('ai-modal').classList.remove('hidden');
};

document.getElementById('hm-delete').onclick = ()=>{
  const all = store.get('meals', []);
  const idx = all.findIndex(x=>x.time===hmEditingKey);
  if(idx<0) return;
  all.splice(idx,1);
  store.set('meals', all);
  paintMeals();
  updateStats();
  renderDailyDetails(selectedDate);
  hmModal.classList.add('hidden');
};
  // ç»‘å®šè§†å›¾åˆ‡æ¢
  document.querySelectorAll('[data-view]').forEach(btn=>{
    btn.onclick = () => {
      document.querySelectorAll('[data-view]').forEach(b=>b.classList.remove('bg-white','dark:bg-neutral-700','shadow-sm'));
      btn.classList.add('bg-white','dark:bg-neutral-700','shadow-sm');
      historyView = btn.getAttribute('data-view');
      periodStart = historyView==='week' ? startOfWeek(selectedDate) : startOfMonth(selectedDate);
      renderPeriodHeader();
      renderCalendar();
      initChart(window.__chartState?.metric || 'calories', historyView, periodStart, selectedDate);
    };
  });

  // ä¸Š/ä¸‹ä¸€æœŸ
  document.getElementById('prev-period').onclick = () => {
    periodStart = historyView==='week' ? addDays(periodStart,-7) : new Date(periodStart.getFullYear(), periodStart.getMonth()-1, 1);
    // åˆ‡æ¢æœŸæ—¶é»˜è®¤é€‰ä¸­è¯¥å‘¨æœŸç¬¬ä¸€å¤©
    selectedDate = periodStart;
    renderPeriodHeader(); renderCalendar(); renderDailyDetails(selectedDate);
    initChart(window.__chartState?.metric || 'calories', historyView, periodStart, selectedDate);
  };
  document.getElementById('next-period').onclick = () => {
  const today = new Date();
  const next = historyView==='week' ? addDays(periodStart,7) : new Date(periodStart.getFullYear(), periodStart.getMonth()+1, 1);

  const limit = historyView==='week' ? startOfWeek(today) : startOfMonth(today);
  if (next > limit) return;
  periodStart = next;
  selectedDate = periodStart;
  renderPeriodHeader();
  renderCalendar();
  renderDailyDetails(selectedDate);
  initChart(window.__chartState?.metric || 'calories', historyView, periodStart, selectedDate); 
};

  // åˆæ¬¡æ¸²æŸ“
  renderPeriodHeader();
  renderCalendar();
  renderDailyDetails(selectedDate);

  // å›¾è¡¨ï¼ˆæ¼”ç¤ºé™æ€ï¼‰
  initChart('calories', historyView, periodStart, selectedDate);
}

// é¡¶éƒ¨ä¸­é—´çš„æ—¥æœŸèŒƒå›´/æœˆä»½
function renderPeriodHeader(){
  const el = document.getElementById('current-period');
  if(historyView==='week'){
    const start = periodStart;
    const end = addDays(start,6);
    el.textContent = `${start.getMonth()+1}æœˆ${start.getDate()}æ—¥ - ${end.getMonth()+1}æœˆ${end.getDate()}æ—¥`;
  }else{
    el.textContent = `${periodStart.getFullYear()}å¹´ ${periodStart.getMonth()+1}æœˆ`;
  }

  // â€œä¸‹ä¸€æœŸâ€æ˜¯å¦ç¦ç”¨
  const nextBtn = document.getElementById('next-period');
  const today = new Date();
  const limit = historyView==='week' ? startOfWeek(today) : startOfMonth(today);
  const willNext = historyView==='week' ? addDays(periodStart,7) : new Date(periodStart.getFullYear(), periodStart.getMonth()+1, 1);
  if (willNext > limit){ nextBtn.disabled = true; nextBtn.classList.add('opacity-50'); }
  else { nextBtn.disabled = false; nextBtn.classList.remove('opacity-50'); }
}

// æ¸²æŸ“å‘¨ / æœˆæ—¥å†
function renderCalendar(){
  const box = document.getElementById('calendar-wrap');
  const todayKey = ymd(new Date());
  let html = '';

  const dayCell = (date) => {
    const key = ymd(date);
    const t = totalsOfDate(date);
    const isSel = key === ymd(selectedDate);
    const isToday = key === todayKey;
    return `
  <button class="text-left p-3 rounded-xl border ${isSel ? 'border-primary bg-primary/5' : 'border-transparent hover:bg-neutral-50 dark:hover:bg-neutral-700/40'} transition-colors"
          data-pick="${key}">
    <div class="flex items-center gap-2">
      <div class="text-base font-medium ${isSel?'text-primary':''}">${date.getDate()}</div>
      ${mealsOfDate(date).some(m=>m.backfill) ? '<span class="text-[10px] px-1 py-0.5 rounded bg-primary/10 text-primary">è¡¥å½•</span>' : ''}
    </div>
    <div class="mt-2 text-xs text-neutral-500 dark:text-neutral-400">${t.kcal} kcal</div>
  </button>
`;
  };

  if(historyView==='week'){
    html += '<div class="grid grid-cols-7 gap-2">';
    for(let i=0;i<7;i++){
      html += dayCell(addDays(periodStart,i));
    }
    html += '</div>';
  }else{
    const first = startOfMonth(periodStart);
    const last = endOfMonth(periodStart);
    const start = startOfWeek(first);               // æœˆå‰è¡¥é½åˆ°å‘¨ä¸€
    const cells = [];
    for(let d=0; d<42; d++){                        // 6 è¡Œ * 7 åˆ—
      const cur = addDays(start,d);
      const inMonth = cur.getMonth() === periodStart.getMonth();
      cells.push(`<div class="${inMonth?'':'opacity-40'}">${dayCell(cur)}</div>`);
    }
    html += `
      <div class="grid grid-cols-7 gap-2 mb-2 text-xs text-neutral-500 dark:text-neutral-400">
        <div class="text-center">ä¸€</div><div class="text-center">äºŒ</div><div class="text-center">ä¸‰</div>
        <div class="text-center">å››</div><div class="text-center">äº”</div><div class="text-center">å…­</div><div class="text-center">æ—¥</div>
      </div>
      <div class="grid grid-cols-7 gap-2">${cells.join('')}</div>
    `;
  }

  box.innerHTML = html;

  // é€‰æ—¥
  box.querySelectorAll('[data-pick]').forEach(btn=>{
    btn.onclick = () => {
      selectedDate = new Date(btn.getAttribute('data-pick'));
      renderCalendar();
      renderDailyDetails(selectedDate);
      initChart(window.__chartState?.metric || 'calories', historyView, periodStart, selectedDate);
    };
  });
}

function renderDailyDetails(date){
  const list = document.getElementById('daily-meals');
  const head = document.getElementById('detail-date');
  const target = document.getElementById('daily-target');
  const summary = document.getElementById('daily-summary');

  const two = n => n<10?'0'+n:''+n;
  const ymd = d => `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`;

  head.textContent = ymd(date);

  // ç›®æ ‡ï¼ˆç”¨â€œä»Šæ—¥æ ‡å‡†â€è¾“å…¥æ¨ç®—ï¼‰
  const goalCal = +document.getElementById('goal-cal').value || 2000;
  const goalPro = +document.getElementById('goal-pro').value || 100;
  const goalFat = +document.getElementById('goal-fat').value || 65;
  let goalCarbs = Math.round((goalCal - goalPro*4 - goalFat*9) / 4);
  if (!isFinite(goalCarbs) || goalCarbs < 0) goalCarbs = 0;
  target.textContent = `å½“æ—¥ç›®æ ‡ï¼š${goalCal}kcalï½œè›‹ç™½${goalPro}gï½œç¢³æ°´${goalCarbs}gï½œè„‚è‚ª${goalFat}g`;

  // åˆ—è¡¨
  const meals = mealsOfDate(date).sort((a,b)=>a.time-b.time);
  list.innerHTML = meals.map(m => {
    const t = m.totals || {kcal:0,protein:0,carbs:0,fat:0};
    const timeText = new Date(m.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    return `
      <button class="w-full text-left border-b border-neutral-100 dark:border-neutral-700 pb-4" data-open="${m.time}">
        <div class="flex justify-between items-start mb-1">
          <div class="font-medium text-sm">${MEAL_I18N[m.mealType] || 'â€”'} <span class="ml-2 text-xs text-neutral-500">${timeText}</span></div>
          <div class="text-sm">${t.kcal}kcal</div>
        </div>
        <div class="text-sm text-neutral-700 dark:text-neutral-300 mb-1">${m.text}</div>
        <div class="text-xs text-neutral-500 dark:text-neutral-400">è›‹ç™½è´¨ ${t.protein}g Â· ç¢³æ°´ ${t.carbs}g Â· è„‚è‚ª ${t.fat}g</div>
      </button>
    `;
  }).join('');

  // æ€»ç»“
  const total = totalsOfDate(date);
  summary.classList.toggle('hidden', meals.length===0);
  summary.innerHTML = meals.length===0 ? '' : `
    <div class="flex justify-between items-center text-sm font-medium mb-2"><div>å½“æ—¥æ€»è®¡</div><div>${total.kcal}kcal</div></div>
    <div class="grid grid-cols-3 gap-2 text-center text-xs text-neutral-500 dark:text-neutral-400">
      <div>è›‹ç™½è´¨ ${total.protein.toFixed(1)}g</div>
      <div>ç¢³æ°´ ${total.carbs.toFixed(1)}g</div>
      <div>è„‚è‚ª ${total.fat.toFixed(1)}g</div>
    </div>
  `;

  // ç‚¹å‡»ä»»æ„ä¸€é¤ -> æ‰“å¼€å¼¹å±‚
  list.querySelectorAll('[data-open]').forEach(btn=>{
    btn.onclick = () => openHistMealModal(+btn.getAttribute('data-open'));
  });
}

// å‘¨/æœˆå›¾è¡¨ï¼šå‘¨=7æ ¹ï¼›æœˆ=å½“æœˆ1å·åˆ°æœˆæœ«çš„å¤©æ•°æ ¹ï¼›é€‰ä¸­æ—¥æ”¾ç¬¬ä¸€æ ¹å¹¶é«˜äº®
function initChart(metric = 'calories', view = historyView, start = periodStart, picked = selectedDate) {
  const chartDom = document.getElementById('metrics-chart');
  const existing = echarts.getInstanceByDom(chartDom);
if (existing) existing.dispose();
const myChart = echarts.init(chartDom);
  const isDark = document.documentElement.classList.contains('dark');
  const textColor = isDark ? '#F9FAFB' : '#1F2937';
  const axisLineColor = isDark ? '#4B5563' : '#E5E7EB';
  const splitLineColor = isDark ? '#374151' : '#F3F4F6';
  let barColor = '#EF4444';
  if (metric === 'protein') barColor = '#FF7A00';
  if (metric === 'carbs')   barColor = '#00B4D8';
  if (metric === 'fat')     barColor = '#8B5CF6';

  // ç»„è£…æ—¥æœŸåºåˆ—
  const days = [];
  if (view === 'week') {
    for (let i = 0; i < 7; i++) days.push(addDays(start, i));
  } else {
    const first = startOfMonth(start);
    const last  = endOfMonth(start);
    for (let d = new Date(first); d <= last; d = addDays(d, 1)) days.push(new Date(d));
  }

  // å…ˆæŒ‰è‡ªç„¶é¡ºåºç®—å€¼
  const raw = days.map(d => {
    const t = totalsOfDate(d);
    if (metric === 'calories') return t.kcal || 0;
    if (metric === 'protein')  return +(t.protein || 0).toFixed(1);
    if (metric === 'carbs')    return +(t.carbs   || 0).toFixed(1);
    if (metric === 'fat')      return +(t.fat     || 0).toFixed(1);
    return 0;
  });

  // é€‰ä¸­æ—¥æœŸæŒªåˆ°ç¬¬ä¸€æ ¹
  const pickKey = ymd(picked);
  const idx = days.findIndex(d => ymd(d) === pickKey);
  let labels = days.map(d => (view === 'week') ? `${d.getMonth()+1}/${d.getDate()}` : (d.getDate() + 'æ—¥'));
  let vals   = raw.slice();
  if (idx > -1) {
    const d0 = days[idx], v0 = raw[idx], l0 = labels[idx];
    days.splice(idx, 1); raw.splice(idx, 1); labels.splice(idx, 1);
    days.unshift(d0);    raw.unshift(v0);    labels.unshift(l0);
    vals = raw;
  }

  // æœˆè§†å›¾åšâ€œç»†ç«–çº¿â€æ•ˆæœï¼šé™åˆ¶æŸ±å®½
  const option = {
    color: [barColor],
    grid: { left: '6%', right: '4%', bottom: '14%', top: 28, containLabel: true },
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
    xAxis: {
      type: 'category',
      data: labels,
      axisLine: { lineStyle: { color: axisLineColor } },
      axisLabel: { color: textColor, fontSize: 12 },
      axisTick: { show: false }
    },
    yAxis: {
      type: 'value',
      name: metric === 'calories' ? 'çƒ­é‡ (kcal)' : (metric === 'protein' ? 'è›‹ç™½è´¨ (g)' : metric === 'carbs' ? 'ç¢³æ°´ (g)' : 'è„‚è‚ª (g)'),
      nameTextStyle: { color: textColor, fontSize: 12, padding: [0,0,0,10] },
      axisLine: { show: false },
      axisLabel: { color: textColor, fontSize: 12 },
      splitLine: { lineStyle: { color: splitLineColor } },
      axisTick: { show: false }
    },
    series: [{
      type: 'bar',
      data: vals,
      barWidth: view === 'month' ? undefined : '40%',
      // 30æ ¹ä»¥ä¸Šæ—¶ä½¿ç”¨æ›´ç»†çš„æŸ±ä½“
      barCategoryGap: view === 'month' ? '80%' : '30%',
      barMaxWidth: view === 'month' ? 6 : 28,
      itemStyle: {
        borderRadius: [3, 3, 0, 0],
        // ç¬¬ä¸€æ ¹ï¼ˆè¢«é€‰ä¸­çš„é‚£å¤©ï¼‰é«˜äº®ä¸ºçº¯è‰²ï¼Œå…¶ä½™ä½¿ç”¨é»˜è®¤è‰²
        color: function (params) {
          if (params.dataIndex === 0) return barColor;
          return echarts.color.lift(barColor, 0.15);
        }
      }
    }]
  };

  myChart.setOption(option);
  window.addEventListener('resize', () => myChart.resize());

  // è®°ä½å½“å‰é…ç½®ï¼Œç»™â€œåˆ‡æŒ‡æ ‡â€æ—¶å¤ç”¨
  window.__chartState = { metric, view, start, picked };
}
// æŒ‡æ ‡æŒ‰é’®
document.querySelectorAll('[data-metric]').forEach(btn=>{
  btn.onclick = () => {
    document.querySelectorAll('[data-metric]').forEach(b=>b.classList.remove('bg-white','dark:bg-neutral-600','shadow-sm'));
    btn.classList.add('bg-white','dark:bg-neutral-600','shadow-sm');
    const metric = btn.getAttribute('data-metric');
    initChart(metric, historyView, periodStart, selectedDate);
  };
});

// åˆå§‹åŒ–ï¼šåŠ è½½ä»Šå¤©ç›®æ ‡ï¼ˆä¾èµ– profile é»˜è®¤ï¼‰
loadGoalsForToday();
loadProfile();
// åˆå§‹è¿›å…¥â€œä»Šå¤©â€
switchTab('today');
    </script>
  </body>
</html>
