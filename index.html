function openHistMealModal(mealKey){
  const all = store.get('meals', []);
  const m = all.find(x=>x.time===mealKey);
  if(!m) return;
  hmEditingKey = mealKey;

  const titleMap = {breakfast:'早餐', lunch:'午餐', dinner:'晚餐', night:'夜宵', snack:'加餐'};
  document.getElementById('hm-title').textContent = (titleMap[m.mealType]||'餐') + '详情';

  const d = new Date(m.time);
  const two = n => n<10?'0'+n:''+n;
  document.getElementById('hm-date').textContent = `${d.getFullYear()}-${two(d.getMonth()+1)}-${two(d.getDate())}`;
  document.getElementById('hm-note').value = m.note || '';

  // 渲染每个食物（只读）
  hmItems.innerHTML = '';
  (m.items || []).forEach((it) => {
    const row = document.createElement('div');
    row.className = 'p-3 rounded-xl bg-neutral-50 dark:bg-neutral-700';
    row.innerHTML = `
      <div class="flex justify-between items-center">
        <div class="font-medium">${it.name || '食物'}</div>
        <div class="text-sm text-neutral-500">${Math.max(0, Math.round(+it.kcal || 0))}kcal</div>
      </div>
      <div class="grid grid-cols-3 gap-2 mt-2 text-xs text-neutral-500 dark:text-neutral-400">
        <div>蛋白 ${(+it.protein || 0).toFixed(1)}g</div>
        <div>碳水 ${(+it.carbs   || 0).toFixed(1)}g</div>
        <div>脂肪 ${(+it.fat     || 0).toFixed(1)}g</div>
      </div>
    `;
    hmItems.appendChild(row);
  });

  // ★ 新增：计算并回填「本餐总计」
  const sum = calcTotals(m.items || []);
  document.getElementById('hm-total-kcal').textContent = `${sum.kcal}kcal`;
  document.getElementById('hm-total-pro').textContent  = sum.protein.toFixed(1);
  document.getElementById('hm-total-carb').textContent = sum.carbs.toFixed(1);
  document.getElementById('hm-total-fat').textContent  = sum.fat.toFixed(1);

  // 修改保存按钮文案
  document.getElementById('hm-save').textContent = '让 AI 生成新的一餐';

  hmModal.classList.remove('hidden');
  hmModal.classList.add('flex');
}
